# CLAUDE.md — DEC DASH 2.0

## Project Overview

Executive dashboard for the Dads' Education Center (DEC) nonprofit. Next.js 15 + Convex backend.

## Commands

- `npm run dev` — Start Next.js dev server
- `npx convex dev` — Start Convex backend (watch mode, deploys on save)
- `npx convex dev --once` — Deploy Convex once without watching
- `npm run build` — Production build
- `npm run lint` — Run ESLint

## Architecture

### Backend (Convex)

- Schema defined in `convex/schema.ts`
- `_generated/` folder is auto-generated by `npx convex dev` — don't edit
- Actions using npm packages (`intuit-oauth`, `googleapis`, `openai`) need `"use node"` runtime directive
- Auth: `@convex-dev/auth` with Password provider
- RBAC: `requireRole()` helper in `convex/users.ts` — roles are `admin`, `manager`, `staff`, `readonly`
- QB/Sheets data cached in Convex tables, synced via crons (QB: 15min, Sheets: 30min)
- OAuth configs (`quickbooksConfig`, `constantContactConfig`) are global singletons queried with `.first()`
- AI expense categorization: `allocationActions.ts` (core engine), `allocation.ts` (public queries/mutations), `allocationInternal.ts` (internal mutations), `allocationTypes.ts` (shared types/config)
- Categorization pipeline: pre-score expenses → batch to OpenAI (gpt-4o) → post-validate → persist → user review → submit to QB

### Frontend (Next.js)

- App Router with `(dashboard)` route group for authenticated pages
- Tailwind CSS v4 — uses `@theme` inline block, not `tailwind.config.js`
- Theme colors: `--primary: #1B5E6B` (teal), `--accent: #6BBF59` (green) — matches DEC logo
- Charts use `react-chartjs-2` / `chart.js`

### Design System

- **Fonts**: Nunito (body, `--font-nunito`), Fraunces (display headings, `--font-fraunces`), Geist Mono (code, `--font-geist-mono`)
- **Warm palette**: Light — cream `#F7F5F0` bg, warm white `#FFFEF9` surfaces, warm borders `#D6D0B8`, dark forest foreground `#2C3E2D`. Dark — `#141F16` bg, `#1A2E1E` surface, `#334D38` border, sage `#E2E8D4` foreground
- **Shadows**: Green-tinted warm shadows via CSS variables (`--warm-shadow-sm/md/lg/xl`), registered in `@theme inline`
- **Utility classes** (in `globals.css`): `.noise-texture`, `.animate-fade-up`, `.animate-scale-in`, `.stagger-children`, `.hover-lift`, `.bg-warm-gradient`, `.organic-blob`
- **Sidebar**: Dark gradient (`from-primary-dark to-[#0D2216]`) with white-on-dark text
- **Header**: Frosted glass (`bg-surface/80 backdrop-blur-md`)
- **Buttons**: Pill-shaped (`rounded-full`) with hover lift
- **Cards**: `rounded-2xl` with `shadow-[var(--warm-shadow-sm)]` and `hover-lift`
- **Charts**: Warm green grid lines (`rgba(45,106,79,0.06)`), dark green tooltips, `borderRadius: 8` on bars, Nunito font family

## Key Patterns

- Convex queries/mutations are called via `useQuery`/`useMutation` from `convex/react`
- OAuth callbacks are Next.js API routes at `src/app/api/{provider}/callback/route.ts`
- OAuth callbacks use `ConvexHttpClient` (not React hooks) since they run server-side
- `intuit-oauth` has no `@types` package — custom type declarations at `src/types/intuit-oauth.d.ts`
- Allocation scoring factors: s1_pacing (0-40), s2_time (0-25), s3_diversification (0-25), s4_budget (0-10)
- `allocationActions.ts` duplicates `getAuthenticatedConfig` helper from `quickbooksActions.ts` (not exported there)

## Production Deployment

### Server
- **Host:** Hostinger VPS at `187.77.19.63`
- **User:** `root`
- **Password:** `mnkC93'ksa5'HRikz2W@`
- **Stack:** Ubuntu, Nginx, Node.js 22, PM2
- **Webapp path:** `/var/www/webapp/`
- **PM2 app name:** `dec-dash` (port 3000)

### Deploy Steps

Next.js uses `output: "standalone"` — build locally, rsync to server, restart PM2:

```bash
# 1. Build locally
npm run build

# 2. Rsync standalone build (preserves .env.local and ecosystem.config.cjs on server)
export SSHPASS="mnkC93'ksa5'HRikz2W@"
sshpass -e rsync -avz --delete \
  ".next/standalone/" root@187.77.19.63:/var/www/webapp/ \
  --exclude='.env.local' --exclude='ecosystem.config.cjs' \
  -e "ssh -o StrictHostKeyChecking=no"

# 3. Rsync static assets and public dir
sshpass -e rsync -avz ".next/static/" root@187.77.19.63:/var/www/webapp/.next/static/ \
  -e "ssh -o StrictHostKeyChecking=no"
sshpass -e rsync -avz "public/" root@187.77.19.63:/var/www/webapp/public/ \
  -e "ssh -o StrictHostKeyChecking=no"

# 4. Restart PM2
sshpass -e ssh -o StrictHostKeyChecking=no root@187.77.19.63 "pm2 restart dec-dash"
```

### Convex Production
- **Dev deployment:** `aware-finch-86` (set in `CONVEX_DEPLOYMENT`)
- **Prod deployment:** `zany-condor-488`
- Deploy to prod: `npx convex deploy --yes`
- Deploy to dev: `npx convex dev --once`

## Gotchas

- Directory name has a space ("DEC-DASH 2.0") — always quote paths in shell commands
- `npx convex init` is deprecated — use `npx convex dev --once --configure=new`
- Convex `_generated/api.d.ts` changes frequently — commit it when schema changes
