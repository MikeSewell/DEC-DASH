---
phase: 03-google-calendar-integration
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/dashboard/CalendarWidget.tsx
  - src/app/(dashboard)/dashboard/page.tsx
autonomous: false
requirements: [CAL-04, CAL-05]

must_haves:
  truths:
    - "CalendarWidget registered in SECTION_COMPONENTS map as 'calendar' key"
    - "Widget shows loading skeleton when query is undefined"
    - "Widget shows 'Connect Google Calendar' prompt with link to /admin?tab=google-calendar when result is null"
    - "Widget groups events by day with headers: 'Today', 'Tomorrow', 'Wednesday Mar 5' etc."
    - "Day headers include count badge showing number of events that day"
    - "Each event row displays title, time (formatted), calendar source (color dot + name), and location when available"
    - "All-day events pinned to top of each day group, displayed without time column"
    - "Currently-happening events have colored left border highlight"
    - "Events capped at ~10 visible, with 'Show more' link to expand remaining"
    - "Click on event opens Google Calendar in new tab via htmlLink"
    - "Empty today shows 'No events today' message but upcoming days still render"
  artifacts:
    - src/components/dashboard/CalendarWidget.tsx
  key_links:
    - "CalendarWidget uses useCalendarEvents() hook from src/hooks/useGoogleCalendar.ts"
    - "Dashboard page imports CalendarWidget and maps it to 'calendar' in SECTION_COMPONENTS"
    - "Color dots use CALENDAR_DOT_COLORS from src/lib/constants.ts indexed by calendar position"
---

<objective>
Build the CalendarWidget dashboard component showing today's events and the next 7 days in an agenda-list format, and wire it into the dashboard section system.

Purpose: Give Kareem a unified calendar view on the dashboard so he sees upcoming events without opening Google Calendar.
Output: CalendarWidget.tsx component + dashboard page wiring.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-google-calendar-integration/03-CONTEXT.md
@.planning/phases/03-google-calendar-integration/03-01-SUMMARY.md

@src/app/(dashboard)/dashboard/page.tsx
@src/components/dashboard/ExecutiveSnapshot.tsx
@src/components/dashboard/WhatNeedsAttention.tsx
@src/hooks/useGoogleCalendar.ts
@src/lib/constants.ts
@src/types/index.ts

<interfaces>
<!-- Contracts from Plan 01/02 that this plan consumes -->

From convex/googleCalendar.ts getEvents return shape:
```typescript
// null when not configured
// { events: CalendarEvent[], lastSyncAt: number | null } when configured
interface CalendarEvent {
  _id: Id<"googleCalendarCache">;
  eventId: string;
  calendarId: string;
  calendarDisplayName: string;
  summary: string;
  startAt: number;       // Unix ms timestamp
  endAt: number;         // Unix ms timestamp
  isAllDay: boolean;
  location?: string;
  htmlLink?: string;
  lastSyncAt: number;
}
```

From src/hooks/useGoogleCalendar.ts:
```typescript
export function useCalendarEvents() → useQuery(api.googleCalendar.getEvents)
// Returns undefined (loading), null (not configured), or { events, lastSyncAt }
```

From src/lib/constants.ts:
```typescript
export const CALENDAR_DOT_COLORS = ["#1B5E6B", "#6BBF59", "#2B9E9E", "#8CC63F", "#5BBFB5", "#1A7A7A"];
// Usage: CALENDAR_DOT_COLORS[calendarIndex % CALENDAR_DOT_COLORS.length]
```

From src/types/index.ts:
```typescript
export type DashboardSectionId = ... | "calendar";
```

From src/app/(dashboard)/dashboard/page.tsx:
```typescript
const SECTION_COMPONENTS: Record<DashboardSectionId, React.ComponentType> = { ... };
// Import pattern: import CalendarWidget from "@/components/dashboard/CalendarWidget";
// Entry: "calendar": CalendarWidget
```

Design system (from CLAUDE.md + codebase):
- Cards: rounded-2xl, shadow-[var(--warm-shadow-sm)], hover-lift
- Fonts: Fraunces for headings (font-[family-name:var(--font-fraunces)]), Nunito for body
- Colors: --primary #1B5E6B, --accent #6BBF59, warm palette
- Currently-happening highlight: border-l-4 with colored border (from WhatNeedsAttention pattern)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build CalendarWidget component with full agenda-list design</name>
  <files>src/components/dashboard/CalendarWidget.tsx</files>
  <action>
Create `src/components/dashboard/CalendarWidget.tsx` implementing the full calendar widget per the locked decisions in CONTEXT.md.

**Component structure:**

1. **Three-state pattern** (mirrors ExecutiveSnapshot):
   - `result === undefined` → `<CalendarWidgetSkeleton />` (loading skeleton)
   - `result === null` → Not-configured empty state with calendar icon, "No calendars configured" text, and "Connect Google Calendar" link to `/admin?tab=google-calendar`
   - `result` has data → Agenda list view

2. **Skeleton** (`CalendarWidgetSkeleton` — local component):
   - 3-4 animated placeholder rows with `animate-pulse` bars (time bar + title bar + dot)
   - Wrap in same card styling as data view

3. **Data view — agenda list**:

   a. **Day grouping logic**:
   ```typescript
   function getDayLabel(eventDate: Date, today: Date): string {
     const eventDay = new Date(eventDate); eventDay.setHours(0,0,0,0);
     const todayDay = new Date(today); todayDay.setHours(0,0,0,0);
     const diffDays = Math.round((eventDay.getTime() - todayDay.getTime()) / 86400000);
     if (diffDays === 0) return "Today";
     if (diffDays === 1) return "Tomorrow";
     return eventDate.toLocaleDateString("en-US", { weekday: "long", month: "short", day: "numeric" });
   }
   ```
   Group events by day key (`YYYY-MM-DD` from `new Date(event.startAt).toISOString().slice(0, 10)`).

   b. **Calendar color assignment**: Build a `calendarColorMap` from unique `calendarId` values:
   ```typescript
   const uniqueCalendarIds = [...new Set(events.map(e => e.calendarId))];
   const calendarColorMap = Object.fromEntries(
     uniqueCalendarIds.map((id, i) => [id, CALENDAR_DOT_COLORS[i % CALENDAR_DOT_COLORS.length]])
   );
   ```

   c. **Day header**: For each day group, render:
   ```
   <div className="flex items-center gap-2 mt-4 first:mt-0 mb-2">
     <span className="text-sm font-semibold text-foreground">{dayLabel}</span>
     <span className="text-xs px-1.5 py-0.5 rounded-full bg-primary/10 text-primary font-medium">{count}</span>
   </div>
   ```
   Count badge shows `(3)` format per locked decision.

   d. **Event row**: Each event is a clickable row (wrapped in `<a>` if `htmlLink` exists, with `target="_blank" rel="noopener noreferrer"`):
   - **Layout**: Compact horizontal row with `flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-surface-hover/50 transition-colors`
   - **Currently happening highlight**: If `now >= startAt && now < endAt`, add `border-l-4` with the calendar's color from `calendarColorMap`. Use `style={{ borderLeftColor: color }}`.
   - **Time column** (left): For timed events, format start time as `h:mm a` (e.g. "2:30 PM") using `new Date(event.startAt).toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" })`. For all-day events, show "All day" in muted text. Width: `w-16 shrink-0 text-xs text-muted`.
   - **Content column** (center, flex-1):
     - Title: `text-sm font-medium text-foreground truncate` showing `event.summary`
     - Location (if present): `text-xs text-muted truncate` showing location
   - **Calendar source** (right): Color dot (`w-2 h-2 rounded-full shrink-0` with `style={{ backgroundColor: color }}`) + calendar display name (`text-xs text-muted`).

   e. **All-day events pinned to top**: Within each day group, sort all-day events before timed events:
   ```typescript
   const sortedDayEvents = [...dayEvents].sort((a, b) => {
     if (a.isAllDay && !b.isAllDay) return -1;
     if (!a.isAllDay && b.isAllDay) return 1;
     return a.startAt - b.startAt;
   });
   ```

   f. **Show more / collapse**: Track `expanded` state (default `false`). Flatten all events, show first 10 when collapsed. When there are more than 10 total events, show a "Show more (N remaining)" link. When expanded, show all and offer "Show less". Use simple toggle — no animation needed per discretion.

   g. **Empty today**: If today's group has no events, render a subtle message:
   ```
   <div className="flex items-center gap-2 py-3 text-muted">
     <svg className="w-4 h-4" ...calendar-off icon.../>
     <span className="text-sm">No events today</span>
   </div>
   ```
   But still render upcoming days below.

**Key design decisions per locked context:**
- Agenda list format (NOT calendar grid)
- Grouped by day with "Today", "Tomorrow", "Wednesday Mar 5" headers
- Color dot + calendar name per event
- ~10 visible events cap with "Show more"
- Click opens Google Calendar in new tab
- Currently-happening events: colored left border (subtle, not flashy)
- "Connect Google Calendar" empty state matches QB pattern
- Widget uses DashboardSection wrapper (handled by dashboard page, not inside widget)
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - `CalendarWidget.tsx` compiles with no TypeScript errors
    - Component handles three states: skeleton (loading), not-configured (null), data view
    - Events grouped by day with correct headers and count badges
    - All-day events appear at top of their day group
    - Currently-happening events have colored left border
    - Color dots assigned deterministically from CALENDAR_DOT_COLORS
    - Show more/less toggle works for >10 events
    - Event click opens Google Calendar via htmlLink
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 2: Wire CalendarWidget into dashboard and verify visual layout</name>
  <files>src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
**In `src/app/(dashboard)/dashboard/page.tsx`**:

1. Add import at top with the other dashboard component imports:
```typescript
import CalendarWidget from "@/components/dashboard/CalendarWidget";
```

2. Add entry to `SECTION_COMPONENTS` map:
```typescript
const SECTION_COMPONENTS: Record<DashboardSectionId, React.ComponentType> = {
  "executive-snapshot": ExecutiveSnapshot,
  "grant-budget": GrantBudget,
  "grant-tracking": GrantTracking,
  "donation-performance": DonationPerformance,
  "profit-loss": ProfitLoss,
  "client-activity": ClientActivity,
  "programs-coparent": ProgramsCoparent,
  "programs-legal": ProgramsLegal,
  "calendar": CalendarWidget,
};
```

**Verification checkpoint**: User should visually verify:
1. Dashboard loads without errors (CalendarWidget visible in the sections list)
2. If no calendars configured: "Connect Google Calendar" prompt appears with link to admin
3. If calendars configured and synced: events display in agenda format grouped by day
4. Calendar section can be reordered and hidden like other dashboard sections
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - Dashboard page compiles with CalendarWidget wired in
    - CalendarWidget appears in the dashboard section list
    - Widget shows correct state (not-configured or data) based on admin configuration
    - Section is reorderable and hideable via dashboard controls
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — CalendarWidget and dashboard page compile
2. CalendarWidget handles all three states correctly
3. Events display title, time, calendar source (dot + name), and location
4. Day grouping shows "Today", "Tomorrow", and named days with count badges
5. Currently-happening events have colored left border
6. All-day events pinned to top of their day group
7. Show more/less toggle works when >10 events
8. Click opens Google Calendar in new tab
9. Dashboard page has CalendarWidget registered in SECTION_COMPONENTS
10. Visual verification: widget matches dashboard design system (rounded-2xl cards, warm palette)
</verification>

<success_criteria>
- Kareem sees today's events and the next 7 days on the dashboard without opening Google Calendar
- Each event shows title, time, and which calendar it came from
- Widget integrates seamlessly with the existing dashboard section system (reorderable, hideable)
- Not-configured state provides clear path to Admin console setup
</success_criteria>

<output>
After completion, create `.planning/phases/03-google-calendar-integration/03-03-SUMMARY.md`
</output>
