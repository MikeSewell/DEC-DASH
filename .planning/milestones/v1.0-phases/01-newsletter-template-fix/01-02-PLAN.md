---
phase: 01-newsletter-template-fix
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/(dashboard)/newsletter/[id]/page.tsx
  - src/components/newsletter/NewsletterPreview.tsx
autonomous: false
requirements: [NEWS-03, NEWS-04]

must_haves:
  truths:
    - "Kareem sees a size indicator when generated HTML exists, showing current KB and the 400KB limit"
    - "The size indicator turns yellow at 350KB and red at 390KB with descriptive warning text"
    - "The preview panel labels itself as approximate browser rendering with a note that test email via Constant Contact is the definitive check"
    - "Preview still supports desktop/mobile toggle and editable mode with save/cancel"
  artifacts:
    - path: "src/app/(dashboard)/newsletter/[id]/page.tsx"
      provides: "Size indicator pill in newsletter editor header"
      contains: "TextEncoder"
    - path: "src/components/newsletter/NewsletterPreview.tsx"
      provides: "Preview accuracy label and unchanged editable/toggle features"
      contains: "Preview"
  key_links:
    - from: "src/app/(dashboard)/newsletter/[id]/page.tsx"
      to: "newsletter.generatedEmailHtml"
      via: "TextEncoder byte count computation"
      pattern: "TextEncoder.*encode"
    - from: "src/components/newsletter/NewsletterPreview.tsx"
      to: "iframe srcDoc"
      via: "renders HTML in sandboxed iframe with accuracy disclaimer"
      pattern: "srcDoc"
---

<objective>
Add content size validation to the newsletter editor and improve preview accuracy expectations so Kareem knows exactly what the preview represents.

Purpose: Prevent hitting Constant Contact's 400KB limit (NEWS-03) and ensure the preview panel sets accurate expectations about rendering fidelity vs. real email clients (NEWS-04).

Output: Size indicator pill in the editor page header, and an accuracy note on the preview panel explaining that it shows browser rendering, not Outlook-specific rendering.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-newsletter-template-fix/01-CONTEXT.md
@.planning/phases/01-newsletter-template-fix/01-RESEARCH.md
@.planning/phases/01-newsletter-template-fix/01-01-SUMMARY.md

<interfaces>
<!-- Key types and patterns the executor needs. Extracted from codebase. -->

From src/app/(dashboard)/newsletter/[id]/page.tsx:
```typescript
// newsletter object from useQuery:
// newsletter.generatedEmailHtml: string | undefined — the final inlined HTML
// newsletter.generatedEmailSubject: string | undefined
// newsletter.title: string
// newsletter.status: "draft" | "review" | "published"
// newsletter.sections: string (JSON)
// newsletter.campaignActivityId: string | undefined

// The editor page renders: back nav, Card header (title + status + actions), NewsletterEditor
// The "Generate Email" button calls generateEmailHtml action
// The "Preview" button navigates to /newsletter/[id]/review
```

From src/components/newsletter/NewsletterPreview.tsx:
```typescript
interface NewsletterPreviewProps {
  html: string | null | undefined;
  editable?: boolean;
  onSave?: (html: string) => void;
}

// Renders: toolbar (desktop/mobile toggle, edit button), editing banner (save/cancel), iframe with srcDoc
// Edit mode: contentEditable="true" on iframe body, hover outline CSS injected
// Empty state: "No Preview Available" card
```

From src/components/ui/Card.tsx and src/components/ui/Button.tsx:
```typescript
// Card: simple wrapper with padding and shadow
// Button: variant="primary"|"secondary"|"ghost", size="sm"|"md"|"lg", loading prop
```

Design system notes:
- Tailwind v4 with warm palette
- Badge-like pills use: rounded-full, text-xs, px-2 py-0.5, font-medium
- Warning states: bg-amber-100 text-amber-700 (yellow), bg-red-100 text-red-700 (red), bg-green-100 text-green-700 (green)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add content size indicator to newsletter editor page</name>
  <files>src/app/(dashboard)/newsletter/[id]/page.tsx</files>
  <action>
Add a size indicator pill to the newsletter editor page header. This shows the byte size of `generatedEmailHtml` relative to the 400KB Constant Contact limit.

**Where to place it:** Inside the Card header, in the status/actions row. Add it between the Badge (status) and the action buttons, or next to the "Last saved" area. It should be visible but not dominant — a small pill next to the existing status badge works well.

**Implementation:**

1. Compute size from `newsletter.generatedEmailHtml`:
```typescript
const sizeBytes = newsletter.generatedEmailHtml
  ? new TextEncoder().encode(newsletter.generatedEmailHtml).length
  : 0;
const sizeKB = Math.round(sizeBytes / 1024);
const WARN_KB = 350;   // 87.5% of 400KB limit
const ERROR_KB = 390;  // 97.5% of 400KB limit
```

2. Render a pill only when `newsletter.generatedEmailHtml` exists:
```tsx
{newsletter.generatedEmailHtml && (
  <span className={cn(
    "text-xs px-2 py-0.5 rounded-full font-medium",
    sizeKB >= ERROR_KB
      ? "bg-red-100 text-red-700"
      : sizeKB >= WARN_KB
      ? "bg-amber-100 text-amber-700"
      : "bg-green-100 text-green-700"
  )}>
    {sizeKB >= ERROR_KB && "Near limit - "}
    {sizeKB >= WARN_KB && sizeKB < ERROR_KB && "Approaching limit - "}
    {sizeKB} KB / 400 KB
  </span>
)}
```

3. Import `cn` from `@/lib/utils` if not already imported (check the existing imports first).

**Behavior:**
- Green (< 350KB): Shows "X KB / 400 KB" — informational only
- Yellow (350-389KB): Shows "Approaching limit - X KB / 400 KB"
- Red (390KB+): Shows "Near limit - X KB / 400 KB"
- The indicator does NOT block sending — it is informational per user decision
- Only appears when generatedEmailHtml exists (after "Generate Email" has been clicked)
- Recalculates reactively when newsletter data updates (useQuery handles this)

**What NOT to change:**
- Do not modify the generate/preview/status change logic
- Do not add blocking behavior — informational only per CONTEXT.md decisions
- Keep all existing functionality (title editing, blank warning, status badge)
  </action>
  <verify>
Run `npm run build` — page compiles without errors. Visually verify: the pill element exists in the JSX, uses TextEncoder for byte measurement, has three color thresholds (green/yellow/red), and only renders when generatedEmailHtml is truthy.
  </verify>
  <done>
Size indicator pill appears in the newsletter editor header next to the status badge. Shows green below 350KB, yellow at 350-389KB, red at 390KB+. Uses TextEncoder for accurate byte measurement. Does not block sending. Only visible when generated HTML exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add preview accuracy label and rendering note to NewsletterPreview</name>
  <files>src/components/newsletter/NewsletterPreview.tsx</files>
  <action>
Add an accuracy disclaimer to the preview component so Kareem understands the preview shows browser-quality rendering, not Outlook-specific rendering.

**Changes to NewsletterPreview.tsx:**

1. Add a small info note below the toolbar and above the iframe. This should appear when `html` is truthy (preview is showing content):

```tsx
{/* Rendering accuracy note */}
{html && !isEditing && (
  <div className="flex items-start gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-700">
    <svg className="w-3.5 h-3.5 mt-0.5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
    </svg>
    <span>
      Preview shows Gmail/Apple Mail rendering. Outlook may differ slightly (square corners, minor spacing). Send a test email for the definitive check.
    </span>
  </div>
)}
```

Place this between the editing banner (if visible) and the iframe container. When editing IS active, hide this note to reduce clutter.

2. Do NOT change any of the following (per CONTEXT.md locked decisions):
   - The editable preview feature (contentEditable iframe with save/cancel) — keep as-is
   - The desktop/mobile toggle — keep as-is
   - The sandbox attributes — keep as-is
   - The empty state ("No Preview Available") — keep as-is
   - The iframe srcDoc approach — keep as-is

The preview is already using iframe srcDoc which provides browser-quality rendering. The accuracy gap is inherent (browsers render CSS that Outlook strips). The note sets correct expectations without trying to solve an unsolvable problem.
  </action>
  <verify>
Run `npm run build` — component compiles without errors. Visually verify: the info note appears in the JSX, is hidden during edit mode, and contains the text about Gmail/Apple Mail rendering and test email recommendation.
  </verify>
  <done>
NewsletterPreview shows a subtle info note explaining that the preview represents Gmail/Apple Mail rendering and that Outlook may differ. The note recommends sending a test email for definitive verification. All existing preview features (edit, save/cancel, desktop/mobile toggle) remain unchanged.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify newsletter template, size warning, and preview end-to-end</name>
  <action>
Human verifies the complete newsletter pipeline: template rendering, size indicator, and preview accuracy label. This checkpoint covers both Plan 01 (template rewrite) and Plan 02 (size warning + preview).

Steps to verify:
1. Go to http://localhost:3000/newsletter (start dev server with `npm run dev` and Convex with `npx convex dev` if not running)
2. Open an existing newsletter or create a new one
3. Fill in at least a Welcome Message and one other section (e.g., Recent Milestones)
4. Click "Generate Email" — wait for generation to complete
5. Verify: a green size pill appears in the header showing "X KB / 400 KB"
6. Click "Preview" to go to the review page
7. Verify: a blue info note appears above the preview saying "Preview shows Gmail/Apple Mail rendering..."
8. Verify: desktop/mobile toggle still works
9. Verify: "Edit Preview" button still works (contentEditable mode, save/cancel)
10. Optional: Send a test email and check it in Gmail — layout should use tables, no broken styling
  </action>
  <verify>Human confirms all 9 required checks pass.</verify>
  <done>Kareem-facing newsletter pipeline verified: email-safe template, size awareness, accurate preview labeling.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors (both modified frontend files compile)
2. Size indicator uses `TextEncoder().encode().length` for byte measurement (not `html.length`)
3. Size indicator has three thresholds: green (< 350KB), yellow (350-389KB), red (390KB+)
4. Size indicator only renders when `generatedEmailHtml` exists
5. Preview info note appears when HTML is loaded, hidden during edit mode
6. All existing preview features (editable, desktop/mobile toggle, save/cancel) remain functional
</verification>

<success_criteria>
- Kareem sees email content size relative to 400KB limit after generating HTML
- Warning appears at 350KB, urgent warning at 390KB
- Preview clearly communicates it shows browser rendering, not Outlook rendering
- Test email via CC remains the recommended definitive check
- All existing newsletter editor and preview features work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-newsletter-template-fix/01-02-SUMMARY.md`
</output>
