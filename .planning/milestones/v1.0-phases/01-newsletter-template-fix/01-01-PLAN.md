---
phase: 01-newsletter-template-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/newsletterTemplate.ts
  - convex/newsletterActions.ts
  - package.json
autonomous: true
requirements: [NEWS-01, NEWS-02]

must_haves:
  truths:
    - "Newsletter HTML uses table-based layout for every visual block — no div-based colored boxes, highlight sections, or testimonial blocks remain"
    - "No box-shadow, opacity, or overflow:hidden properties appear anywhere in the generated HTML"
    - "All CSS is written inline — no style blocks survive in the final HTML sent to Constant Contact"
    - "The [[trackingImage]] token is present in the email body for Constant Contact open rate tracking"
  artifacts:
    - path: "convex/newsletterTemplate.ts"
      provides: "Email-safe table-based HTML template builder"
      contains: "role=\"presentation\""
    - path: "convex/newsletterActions.ts"
      provides: "juice CSS inlining safety pass in generateEmailHtml pipeline"
      contains: "juice"
    - path: "package.json"
      provides: "juice dependency installed"
      contains: "juice"
  key_links:
    - from: "convex/newsletterActions.ts"
      to: "convex/newsletterTemplate.ts"
      via: "buildNewsletterHtml import"
      pattern: "import.*buildNewsletterHtml.*from.*newsletterTemplate"
    - from: "convex/newsletterActions.ts"
      to: "juice"
      via: "CSS inlining after template generation, before AI polish"
      pattern: "juice\\("
---

<objective>
Rewrite the newsletter HTML template to use table-based layout for all content sections and add a juice CSS inlining safety pass to the email generation pipeline.

Purpose: Fix broken rendering in Gmail, Outlook (Windows/Word renderer), and Apple Mail caused by div-based layout blocks, box-shadow, opacity, and overflow:hidden in the current template. Add defensive CSS inlining for any style blocks the AI polish pass may introduce.

Output: Email-safe `newsletterTemplate.ts` with all div blocks converted to tables, unsupported CSS removed, and `newsletterActions.ts` with juice inlining integrated into the generation pipeline.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-newsletter-template-fix/01-CONTEXT.md
@.planning/phases/01-newsletter-template-fix/01-RESEARCH.md

<interfaces>
<!-- Key functions and types the executor needs. Extracted from codebase. -->

From convex/newsletterTemplate.ts:
```typescript
interface NewsletterSections {
  welcomeMessage?: string;
  recentMilestones?: string;
  personalReflections?: string;
  programUpdates?: string;
  programHighlights?: string;
  participantTestimonials?: string;
  upcomingEvents?: string;
  dadOfMonthName?: string;
  dadOfMonthStory?: string;
  photoLink?: string;
  communityEvents?: string;
  partnerships?: string;
  fatherhoodStat?: string;
  volunteerNeeds?: string;
  donationCampaigns?: string;
  readerSupport?: string;
  contactInfo?: string;
  socialMediaCTA?: string;
  additionalNotes?: string;
}

function hasContent(...fields: (string | undefined)[]): boolean;
function nl2br(text: string): string;
export function buildNewsletterHtml(title: string, sections: NewsletterSections): string;
```

From convex/newsletterActions.ts:
```typescript
"use node";
// generateEmailHtml action: calls buildNewsletterHtml() -> sends rawHtml to OpenAI -> saves result
// sendTestEmail action: sends test via CC API
// sendNewsletter action: sends real newsletter via CC API
export const generateEmailHtml = action({ args: { id: v.id("newsletters") }, handler: async (ctx, args) => { ... } });
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite newsletterTemplate.ts with table-based layout and email-safe CSS</name>
  <files>convex/newsletterTemplate.ts</files>
  <action>
Rewrite the `buildNewsletterHtml` function to fix all email client compatibility issues. The function signature, `NewsletterSections` interface, `hasContent()` helper, and `nl2br()` helper remain unchanged. All section logic (conditional rendering based on `hasContent`) stays the same. Only the HTML output changes.

**Specific fixes (reference line numbers from current file):**

1. **Main container table (line 65):** Remove `box-shadow:0 2px 10px rgba(0,0,0,0.1)`. Keep `border-radius:8px` for progressive enhancement (Apple Mail/Gmail render it; Outlook ignores safely). Add `width="600"` HTML attribute alongside existing `max-width:600px` CSS.

2. **Header opacity (lines 79-80):** Remove `opacity:0.95` from the `<h2>` and `opacity:0.9` from the `<p>`. Replace with direct `color:#ffffff` on the h2 and `color:#f2f2f2` on the tagline paragraph. The slight tint was decorative.

3. **Recent Milestones (line 106):** Replace `<div style="background-color:#f8f9fa;padding:20px;border-radius:6px;margin-bottom:20px;border-left:4px solid #7DACC4;">` with the email-safe highlighted box pattern:
```html
<table role="presentation" border="0" width="100%" cellspacing="0" cellpadding="0" style="margin-bottom:20px;">
<tr>
<td style="border-left:4px solid #7DACC4;" bgcolor="#f8f9fa">
  <table role="presentation" border="0" width="100%" cellspacing="0" cellpadding="0">
  <tr>
  <td style="padding:20px;font-family:Arial,Helvetica,sans-serif;">
    <!-- heading + content here -->
  </td>
  </tr>
  </table>
</td>
</tr>
</table>
```
Note: Use `bgcolor` attribute as Outlook fallback alongside `background-color` inline style on the outer `<td>`. Nested table is needed because Outlook handles padding + border incorrectly on the same `<td>`.

4. **Program Highlights (line 129):** Same div-to-table conversion as Recent Milestones — same highlighted box pattern with `bgcolor="#f8f9fa"` and `border-left:4px solid #7DACC4`.

5. **Participant Testimonials (lines 137-142):** Replace both nested `<div>` elements with the table-based testimonial pattern:
   - Outer: `<table>` with `border:2px solid #7DACC4` and white background
   - Inner: Nested `<table>` with `bgcolor="#f8f9fa"` and `border-left:3px solid #345c72`
   Remove `border-radius` from these elements (they had `border-radius:6px` and `border-radius:4px`).

6. **Dad of the Month (line 161):** Remove `overflow:hidden` from the table style. Keep `bgcolor="#f8f9fa"` (already a table, just needs the overflow removed). Keep `border-radius:50%` on the photo `<img>` — Apple Mail/Gmail render it, Outlook shows square (acceptable).

7. **Community Events (line 187):** Replace `<div style="background-color:#f8f9fa;padding:20px;border-radius:6px;margin-bottom:20px;">` with table equivalent using `bgcolor="#f8f9fa"`.

8. **Partnerships (line 201):** Replace `<div style="background-color:#e8f4f8;padding:20px;border-radius:6px;border-left:4px solid #7DACC4;">` with the highlighted box table pattern, using `bgcolor="#e8f4f8"`.

9. **Fatherhood Stats (line 219):** Remove `opacity:0.95` from the stat text `<p>`. Replace with `color:#ffffff` directly. The `border-radius:6px` on the `<td>` can stay for progressive enhancement.

10. **Volunteer Request yellow box (lines 254-261):** Replace the `<table>` that wraps the yellow box content — remove `border-radius:6px` from the `<td>`, keep `bgcolor="#fff3cd"` and `border-left:4px solid #ffc107`. This one is already a `<table>` but has `border-radius` which Outlook ignores — remove it.

11. **Footer (line 318):** Keep `border-radius:0 0 8px 8px` for progressive enhancement. No other changes needed — footer is already table-based.

12. **Add `[[trackingImage]]` before closing footer:** Insert a `<tr><td style="font-size:0;line-height:0;">[[trackingImage]]</td></tr>` row inside the main container table, just before the closing `</table>` of the main container. This is required by Constant Contact for open rate tracking.

**What to preserve (do NOT change):**
- The `NewsletterSections` interface and all field names
- The `hasContent()` and `nl2br()` helper functions
- The conditional section logic (which sections appear based on content)
- DEC brand colors: PRIMARY=#345c72, PRIMARY_LIGHT=#7DACC4, FOOTER_BG=#2a4a5c
- Logo URL, social icon URLs, donate/volunteer links
- Header two-column layout (logo left, title right) — already table-based
- Footer structure — already table-based
- Donate button and volunteer button table structures — already correct
- Social icon table structure — already correct
- Font stack: Arial, Helvetica, sans-serif

**What to avoid and WHY:**
- Do NOT add any `<style>` blocks — email clients strip them (juice is a safety net only)
- Do NOT use `<div>` for any visual block with background color, border, or padding — Outlook Word renderer handles div layout inconsistently
- Do NOT use `box-shadow` anywhere — no email-safe replacement exists
- Do NOT use `opacity` on any element — Outlook Word renderer ignores it
- Do NOT use `overflow:hidden` — no email client supports it
- Do NOT change the section ordering or add new sections
  </action>
  <verify>
Run `npx convex dev --once` to validate the Convex module compiles. Then generate a test HTML by reviewing the output: search the file for "box-shadow" (must find 0 matches), "opacity" (must find 0 matches), "overflow:hidden" (must find 0 matches), and `<div style="background` (must find 0 matches — all colored blocks should be tables). Search for "trackingImage" (must find 1 match).
  </verify>
  <done>
All 12 fixes applied: box-shadow removed, opacity replaced with explicit colors, all div-based highlight/testimonial/community/partnership blocks converted to table-based equivalents, overflow:hidden removed, [[trackingImage]] added. The template compiles and produces HTML with zero instances of box-shadow, opacity, overflow:hidden, or div-based colored blocks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install juice and add CSS inlining pass to generateEmailHtml</name>
  <files>convex/newsletterActions.ts, package.json</files>
  <action>
1. Install juice: `npm install juice`

2. In `convex/newsletterActions.ts`, in the `generateEmailHtml` action handler, add a juice inlining pass between the `buildNewsletterHtml()` call and the OpenAI completion call.

**Current code (lines 22-23):**
```typescript
const rawHtml = buildNewsletterHtml(newsletter.title, sections);
// Step 2: Polish with OpenAI...
```

**New code:**
```typescript
const juice = (await import("juice")).default;

// Step 1: Inject content into branded template
const rawHtml = buildNewsletterHtml(newsletter.title, sections);

// Step 1.5: Inline any <style> blocks (safety net for AI-introduced styles)
const inlinedHtml = juice(rawHtml, {
  removeStyleTags: true,
  preserveMediaQueries: false,
  applyStyleTags: true,
});

// Step 2: Polish with OpenAI (ported from n8n workflow)
const completion = await openai.chat.completions.create({
  // ... existing config ...
  messages: [
    { role: "system", content: `...existing prompt...` },
    { role: "user", content: inlinedHtml },  // <-- was rawHtml, now inlinedHtml
  ],
  // ...
});
```

Use dynamic `await import("juice")` to match the existing pattern in the file (line 13 already uses `await import("openai")`). This avoids top-level import issues in the Convex node runtime.

3. Also add a post-AI-polish juice pass. After the AI response is parsed and markdown fences stripped (around line 83), run juice again on the final HTML before saving:

```typescript
// After stripping markdown fences:
if (html.startsWith("```")) {
  html = html.replace(/^```html?\n?/, "").replace(/\n?```$/, "");
}

// Final safety: inline any <style> blocks the AI polish introduced
html = juice(html, {
  removeStyleTags: true,
  preserveMediaQueries: false,
  applyStyleTags: true,
});
```

This ensures the `generatedEmailHtml` stored in Convex is fully inlined regardless of what the AI outputs.

**Why two juice passes:** The first pass (pre-AI) ensures the AI sees clean inline-only HTML. The second pass (post-AI) catches any `<style>` blocks the AI might introduce in its "polish" step. The stored HTML must be in its final inlined form because it is what gets measured for the 400KB size warning (Plan 02) and sent to Constant Contact.

**What NOT to change:**
- Do not modify `sendTestEmail` or `sendNewsletter` actions — they are working correctly per user decision
- Do not change the OpenAI prompt content
- Do not change the subject line parsing logic
- Keep the `"use node"` directive at line 1 (juice requires Node.js APIs, already satisfied)
  </action>
  <verify>
Run `npm ls juice` to confirm juice is installed. Run `npx convex dev --once` to validate `newsletterActions.ts` compiles with the juice import. Grep the file for "juice(" — should find 2 occurrences (pre-AI and post-AI passes).
  </verify>
  <done>
juice v11.x installed in package.json. generateEmailHtml action runs juice twice: once after buildNewsletterHtml (pre-AI safety) and once after AI polish output (post-AI safety). Both passes use removeStyleTags:true, preserveMediaQueries:false, applyStyleTags:true. The stored generatedEmailHtml is fully inlined with no surviving style blocks.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` succeeds without errors (both newsletterTemplate.ts and newsletterActions.ts compile)
2. `npm ls juice` shows juice installed
3. In newsletterTemplate.ts: zero occurrences of "box-shadow", "opacity", "overflow:hidden", or `<div style="background`
4. In newsletterTemplate.ts: one occurrence of "trackingImage"
5. In newsletterActions.ts: two occurrences of "juice(" (pre-AI and post-AI passes)
6. In newsletterTemplate.ts: all colored/highlighted blocks use `<table role="presentation"` with `bgcolor` attributes
</verification>

<success_criteria>
- The newsletter template produces HTML that uses table-based layout for every visual block
- No unsupported CSS properties (box-shadow, opacity, overflow:hidden) appear in the output
- All CSS is written inline with no style blocks
- The [[trackingImage]] token is present for Constant Contact tracking
- juice inlines any stray style blocks in the generation pipeline
- Convex compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-newsletter-template-fix/01-01-SUMMARY.md`
</output>
