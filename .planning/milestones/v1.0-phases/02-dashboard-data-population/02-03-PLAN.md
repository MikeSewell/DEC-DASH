---
phase: 02-dashboard-data-population
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - src/components/dashboard/WhatNeedsAttention.tsx
  - src/components/dashboard/ClientActivity.tsx
  - src/types/index.ts
  - src/lib/constants.ts
  - src/app/(dashboard)/dashboard/page.tsx
autonomous: true
requirements: [CMD-02, CMD-03, CMD-04]

must_haves:
  truths:
    - "WhatNeedsAttention panel appears at top of dashboard before all reorderable sections"
    - "Panel shows grant deadline items with funder name and date when upcoming deadlines exist"
    - "Panel shows QB connection status warning when QB is not connected"
    - "Panel shows friendly all-clear message when nothing needs attention"
    - "Panel header shows item count badge (e.g. 'What Needs Attention (3)')"
    - "ClientActivity section shows total active clients, new this month, and per-program breakdown"
    - "ClientActivity section has 'View all clients' link to /clients"
    - "ClientActivity section is registered in the reorderable section list"
  artifacts:
    - path: "src/components/dashboard/WhatNeedsAttention.tsx"
      provides: "Attention panel component"
      exports: ["default"]
    - path: "src/components/dashboard/ClientActivity.tsx"
      provides: "Client activity dashboard section"
      exports: ["default"]
    - path: "src/types/index.ts"
      provides: "Updated DashboardSectionId with client-activity"
      contains: "client-activity"
    - path: "src/lib/constants.ts"
      provides: "Updated DEFAULT_DASHBOARD_SECTIONS with client-activity"
      contains: "client-activity"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard with WhatNeedsAttention + ClientActivity wired"
      contains: "WhatNeedsAttention"
  key_links:
    - from: "WhatNeedsAttention.tsx"
      to: "api.grants.getUpcomingDeadlines"
      via: "useQuery"
      pattern: "grants\\.getUpcomingDeadlines"
    - from: "WhatNeedsAttention.tsx"
      to: "api.quickbooks.getConfig"
      via: "useQuery"
      pattern: "quickbooks\\.getConfig"
    - from: "ClientActivity.tsx"
      to: "api.clients.getStats + api.clients.getStatsByProgram"
      via: "useQuery"
      pattern: "clients\\.getStats"
    - from: "dashboard/page.tsx"
      to: "WhatNeedsAttention.tsx"
      via: "direct render before sections loop"
      pattern: "<WhatNeedsAttention"
    - from: "dashboard/page.tsx SECTION_COMPONENTS"
      to: "ClientActivity"
      via: "record entry"
      pattern: "client-activity.*ClientActivity"
---

<objective>
Build the "What Needs Attention" panel (always-visible, top of dashboard) and the "Client Activity" reorderable section, then wire both into the dashboard page.

Purpose: The attention panel (CMD-03) is the core "command center" element — the first thing Kareem sees each morning. It surfaces grant deadlines and QB status without digging. The client activity section (CMD-02) shows active clients with per-program breakdown. Both require the backend queries added in Plan 02-01.

Output: 2 new components wired into the dashboard page
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-dashboard-data-population/02-RESEARCH.md
@.planning/phases/02-dashboard-data-population/02-01-SUMMARY.md

<interfaces>
<!-- Backend queries created in Plan 02-01 that this plan consumes -->

From convex/grants.ts (new in 02-01):
```typescript
export const getUpcomingDeadlines = query({
  args: {},
  handler: async (ctx) => {
    // Returns grants with report dates in next 30 days
    return upcoming; // Array of { grantId, fundingSource, programName, deadlineDate, reportLabel }
  },
});
```

From convex/clients.ts (new in 02-01):
```typescript
export const getStatsByProgram = query({
  args: {},
  handler: async (ctx) => {
    // Returns per-program-type active client counts (role-filtered)
    return { legal: number, coparent: number, other: number };
  },
});
```

From convex/clients.ts (existing):
```typescript
export const getStats = query({
  args: {},
  handler: async (ctx) => {
    return { total: number, active: number, newThisMonth: number };
  },
});
```

From convex/quickbooks.ts (existing):
```typescript
export const getConfig = query({
  handler: async (ctx) => {
    // Returns null | { _id, realmId, companyName, connectedAt, isExpired }
  },
});
```

From convex/grants.ts (existing):
```typescript
export const getStats = query({
  args: {},
  handler: async (ctx) => {
    return { total, byStage, totalAwarded, upcomingReports };
  },
});
```

From src/types/index.ts:
```typescript
export type DashboardSectionId =
  | "executive-snapshot"
  | "grant-budget"
  | "grant-tracking"
  | "donation-performance"
  | "profit-loss"
  | "programs-coparent"
  | "programs-legal";
```

From src/lib/constants.ts:
```typescript
export const DEFAULT_DASHBOARD_SECTIONS: {
  id: DashboardSectionId;
  title: string;
  description: string;
}[] = [ /* 7 entries */ ];
```

From src/app/(dashboard)/dashboard/page.tsx:
```typescript
const SECTION_COMPONENTS: Record<DashboardSectionId, React.ComponentType> = { /* 7 entries */ };
// Sections rendered in visibleSections.map(...) loop inside <DashboardSection> wrapper
```

From skeleton components (created in 02-02):
```typescript
import { StatCardGridSkeleton } from "@/components/dashboard/skeletons/StatCardSkeleton";
import { ListSkeleton } from "@/components/dashboard/skeletons/TableSkeleton";
```

Shared utils:
```typescript
import { formatDate, timeAgo } from "@/lib/utils";
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build WhatNeedsAttention panel component</name>
  <files>
    src/components/dashboard/WhatNeedsAttention.tsx
  </files>
  <action>
Create `src/components/dashboard/WhatNeedsAttention.tsx` — the always-visible attention panel at the top of the dashboard.

**Per user decisions:**
- Panel sits at top of dashboard, before all other sections — first thing Kareem sees
- Always visible — if nothing needs attention, panel says so ("command center" element)
- Item count badge in header (e.g., "What Needs Attention (3)")
- Phase 2 builds basic hardcoded-logic items: upcoming grant deadlines + QB connection status
- Phase 4 will replace the logic with the full alert engine

**Data sources (useQuery):**
```typescript
const deadlines = useQuery(api.grants.getUpcomingDeadlines);
const qbConfig = useQuery(api.quickbooks.getConfig);
const grantStats = useQuery(api.grants.getStats);
```

**Attention item assembly:**
Build an `items` array from the data:
```typescript
interface AttentionItem {
  id: string;
  type: "deadline" | "integration" | "info";
  severity: "warning" | "info" | "success";
  title: string;
  description: string;
  action?: { label: string; href: string };
}
```

1. If `qbConfig === null` (not undefined — null means resolved, not connected): add warning item "QuickBooks Not Connected" with action `{ label: "Connect", href: "/admin" }`
2. If `qbConfig?.isExpired === true`: add warning item "QuickBooks Token Expired" with action to /admin
3. For each entry in `deadlines` array: add deadline item with `title: "{reportLabel} — {fundingSource}"`, `description: "Due {formatDate(deadlineDate)}"`, action `{ label: "View Grant", href: "/grants" }`
4. If `grantStats?.upcomingReports === 0` and QB is connected: no items needed — panel shows all-clear

**Loading state:** If any of the three queries are `undefined`, show a subtle pulse animation on the panel (2-3 skeleton lines). Use `ListSkeleton` from skeletons.

**Panel UI design (per project design system):**
- Wrap in a Card-like container: `rounded-2xl border border-border bg-surface shadow-[var(--warm-shadow-sm)]`
- Header: `font-[family-name:var(--font-fraunces)]` text, bell icon SVG, count badge as `rounded-full bg-primary text-white text-xs px-2 py-0.5`
- When items exist: render as a vertical list with left color accent strip per severity:
  - `warning`: `border-l-4 border-amber-400 bg-amber-50/50` (or warm equivalent)
  - `info`: `border-l-4 border-primary bg-primary/5`
  - `success`: `border-l-4 border-accent bg-accent/5`
- Each item shows: icon per type (calendar for deadline, plug for integration), title, description, optional action link
- When no items: show "All clear — nothing needs your attention right now." centered, with a checkmark icon, in `text-muted`
- When no items, still show the panel header (always visible per user decision)

**Important:** This component is NOT registered in `DashboardSectionId` or `SECTION_COMPONENTS`. It is rendered directly in the dashboard page outside the reorderable sections loop. It does not use `DashboardSection` wrapper.
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>
    - WhatNeedsAttention.tsx exists and exports a default component
    - Component uses useQuery for grants.getUpcomingDeadlines, quickbooks.getConfig, grants.getStats
    - Shows skeleton during loading, items when data exists, all-clear when empty
    - Item count badge in header
    - TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Build ClientActivity section and register both new components in dashboard</name>
  <files>
    src/components/dashboard/ClientActivity.tsx
    src/types/index.ts
    src/lib/constants.ts
    src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
**ClientActivity component (src/components/dashboard/ClientActivity.tsx):**

Create a new dashboard section component. Per user decisions:
- Standalone dashboard section (reorderable/hideable like others)
- Metrics: total active clients, new clients this month, per-program breakdown (Legal vs Co-Parent)
- "View all clients" link in section header for navigation to /clients
- Per-program breakdown as inline badges below total — compact: "Total active: 47" with "Legal: 28 | Co-Parent: 19" as smaller text

Data sources:
```typescript
const clientStats = useQuery(api.clients.getStats);
const programStats = useQuery(api.clients.getStatsByProgram);
```

Loading state: If either query is `undefined`, show `<StatCardGridSkeleton count={3} />` from skeletons.

Layout: 3 stat cards in a grid (`grid-cols-1 sm:grid-cols-3 gap-4`):
1. **Active Clients** — large number (`clientStats.active`), with per-program breakdown below as smaller text: "Legal: {programStats.legal} | Co-Parent: {programStats.coparent}" using inline badges (small rounded pills with program-type colors)
2. **New This Month** — `clientStats.newThisMonth`
3. **Total Clients** — `clientStats.total`

Each card follows the existing rounded-2xl border surface pattern. Add a "View all clients" link at the bottom right:
```tsx
<a href="/clients" className="text-xs text-primary hover:underline flex items-center gap-1">
  View all clients <span>→</span>
</a>
```

Use icons: Users icon for active, UserPlus for new, UsersRound for total (SVG inline, consistent with ExecutiveSnapshot icon style).

**Register client-activity in types (src/types/index.ts):**
Add `"client-activity"` to the `DashboardSectionId` union:
```typescript
export type DashboardSectionId =
  | "executive-snapshot"
  | "grant-budget"
  | "grant-tracking"
  | "donation-performance"
  | "profit-loss"
  | "programs-coparent"
  | "programs-legal"
  | "client-activity";
```

**Register in constants (src/lib/constants.ts):**
Add `client-activity` to `DEFAULT_DASHBOARD_SECTIONS` array AFTER "profit-loss" entry (position: after financial sections, before demographics — per user decision "money then people"):
```typescript
{
  id: "client-activity",
  title: "Client Activity",
  description: "Active clients and program breakdown",
},
```

**Wire into dashboard page (src/app/(dashboard)/dashboard/page.tsx):**

1. Add import for ClientActivity:
```typescript
import ClientActivity from "@/components/dashboard/ClientActivity";
```

2. Add import for WhatNeedsAttention:
```typescript
import WhatNeedsAttention from "@/components/dashboard/WhatNeedsAttention";
```

3. Add `"client-activity": ClientActivity` to the `SECTION_COMPONENTS` record.

4. Render `<WhatNeedsAttention />` in the JSX, BEFORE the `{/* Dashboard Sections */}` comment and the `<div className="space-y-6 stagger-children">` block. Place it after the hidden sections restore panel and before the sections loop:
```tsx
{/* What Needs Attention — always visible */}
<WhatNeedsAttention />

{/* Dashboard Sections */}
<div className="space-y-6 stagger-children">
  {visibleSections.map(...)}
</div>
```

This means WhatNeedsAttention renders OUTSIDE the DashboardSection wrapper and is not part of the reorderable section system. ClientActivity IS part of the reorderable system.
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - ClientActivity.tsx exists and exports default component
    - "client-activity" added to DashboardSectionId in types/index.ts
    - "client-activity" added to DEFAULT_DASHBOARD_SECTIONS in constants.ts after "profit-loss"
    - "client-activity": ClientActivity added to SECTION_COMPONENTS in dashboard/page.tsx
    - WhatNeedsAttention rendered before sections loop in dashboard/page.tsx
    - ClientActivity rendered inside DashboardSection wrapper via SECTION_COMPONENTS
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. WhatNeedsAttention.tsx exists and imports api.grants.getUpcomingDeadlines
3. ClientActivity.tsx exists and imports api.clients.getStats + api.clients.getStatsByProgram
4. `"client-activity"` appears in DashboardSectionId type (grep types/index.ts)
5. SECTION_COMPONENTS record has 8 entries (7 original + client-activity)
6. WhatNeedsAttention rendered outside the sections loop in page.tsx
7. ClientActivity rendered inside DashboardSection wrapper via SECTION_COMPONENTS
</verification>

<success_criteria>
- WhatNeedsAttention panel shows at top of dashboard with attention items or all-clear
- ClientActivity section shows active client stats with per-program breakdown
- Both components use skeleton shimmer for loading states
- Dashboard page compiles and renders both new components
- WhatNeedsAttention is always visible (not reorderable/hideable)
- ClientActivity is reorderable/hideable like other sections
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-data-population/02-03-SUMMARY.md`
</output>
