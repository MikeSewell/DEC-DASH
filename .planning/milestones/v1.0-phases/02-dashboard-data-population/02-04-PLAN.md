---
phase: 02-dashboard-data-population
plan: 04
type: execute
wave: 3
depends_on: [02-01, 02-02, 02-03]
files_modified:
  - src/components/dashboard/ExecutiveSnapshot.tsx
autonomous: false
requirements: [DASH-01, DASH-02, DASH-03, CMD-01]

must_haves:
  truths:
    - "ExecutiveSnapshot shows 3 KPI cards: Cash on Hand, Revenue YTD, Total Expenses"
    - "KPI card values show compact format ($45.2K) with full amount on hover tooltip"
    - "KPI values use green/red color coding for positive/negative financial values"
    - "ExecutiveSnapshot shows skeleton shimmer while data loads (not inline spinner)"
    - "ExecutiveSnapshot shows Connect QuickBooks prompt when QB not connected"
    - "Updated X min ago timestamp appears at bottom of ExecutiveSnapshot section"
    - "Kareem opens the dashboard and sees real financial data, client counts, and attention items"
  artifacts:
    - path: "src/components/dashboard/ExecutiveSnapshot.tsx"
      provides: "Reworked 3-card financial snapshot with skeleton + tooltips + timestamp"
      exports: ["default"]
  key_links:
    - from: "ExecutiveSnapshot.tsx"
      to: "api.quickbooks.getAccounts"
      via: "useAccounts hook"
      pattern: "useAccounts"
    - from: "ExecutiveSnapshot.tsx"
      to: "api.quickbooks.getProfitAndLoss"
      via: "useProfitAndLoss hook"
      pattern: "useProfitAndLoss"
    - from: "ExecutiveSnapshot.tsx"
      to: "formatDollars from @/lib/utils"
      via: "import"
      pattern: "formatDollars"
---

<objective>
Rework ExecutiveSnapshot to show the 3 primary KPI cards (Cash on Hand, Revenue YTD, Total Expenses) with hover tooltips, skeleton loading, disconnected state, and "Updated X ago" timestamp. Final visual verification of the complete dashboard.

Purpose: This is the CMD-01 financial snapshot — the 3 numbers Kareem needs to see first. The current ExecutiveSnapshot shows 4 grant-centric cards with inline spinners and no tooltips. Reworking to 3 QB-focused cards with proper three-state loading completes the core dashboard data population (DASH-01). The checkpoint at the end verifies the entire phase visually.

Output: Reworked ExecutiveSnapshot + visual verification of the full dashboard
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-dashboard-data-population/02-RESEARCH.md
@.planning/phases/02-dashboard-data-population/02-01-SUMMARY.md
@.planning/phases/02-dashboard-data-population/02-02-SUMMARY.md
@.planning/phases/02-dashboard-data-population/02-03-SUMMARY.md

<interfaces>
<!-- Current ExecutiveSnapshot structure to be reworked -->

From src/components/dashboard/ExecutiveSnapshot.tsx:
```typescript
// Current: 4 cards — Active Grants, Total Funds Raised, Cash on Hand, Revenue YTD
// Target: 3 cards — Cash on Hand, Revenue YTD, Total Expenses (CMD-01)

// Existing hooks used:
import { useGrants, useActiveGrants } from "@/hooks/useGrantTracker";
import { useAccounts, useProfitAndLoss } from "@/hooks/useQuickBooks";

// StatCard component exists — reuse but add title attribute for hover tooltip
interface StatCardProps {
  icon: React.ReactNode;
  value: string | number;
  label: string;
  trend?: { value: string; positive: boolean } | null;
  loading?: boolean;
  accentColor?: string;
}
```

From src/lib/utils.ts (available after 02-01):
```typescript
export function formatDollars(amount: number): string { ... }
export function formatCurrency(amount: number): string { ... }
export function formatCurrencyExact(amount: number): string { ... }
export function timeAgo(timestamp: number): string { ... }
```

From src/hooks/useQuickBooks.ts:
```typescript
export function useQuickBooksConfig() { return useQuery(api.quickbooks.getConfig); }
export function useAccounts() { return useQuery(api.quickbooks.getAccounts); }
export function useProfitAndLoss() { return useQuery(api.quickbooks.getProfitAndLoss); }
```

Skeleton (from 02-02):
```typescript
import { StatCardGridSkeleton } from "@/components/dashboard/skeletons/StatCardSkeleton";
```

QB config shape:
```typescript
// useQuickBooksConfig() returns:
// undefined = loading
// null = QB not connected
// { _id, realmId, companyName, connectedAt, isExpired: boolean }
```

QB cache data shape (from useAccounts, useProfitAndLoss):
```typescript
// Returns: undefined | null | { data: T, fetchedAt: number, periodStart?, periodEnd? }
// data.totalCash (from accounts), data.totalRevenue, data.totalExpenses (from P&L)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rework ExecutiveSnapshot to 3 KPI cards with skeleton, tooltips, and timestamp</name>
  <files>
    src/components/dashboard/ExecutiveSnapshot.tsx
  </files>
  <action>
Rewrite ExecutiveSnapshot to focus on 3 QB financial KPI cards per CMD-01 user decision.

**Changes from current implementation:**
1. Remove grant-related imports and cards (useGrants, useActiveGrants) — grant data is displayed elsewhere
2. Add useQuickBooksConfig import for disconnected state detection
3. Add skeleton import for loading state
4. Add formatDollars and formatCurrencyExact imports from @/lib/utils (formatDollars moved there in 02-01)
5. Add timeAgo import from @/lib/utils

**Three-state loading pattern:**
```typescript
const qbConfig = useQuickBooksConfig();
const accounts = useAccounts();
const pnl = useProfitAndLoss();

// Loading: any query still undefined
if (qbConfig === undefined || accounts === undefined || pnl === undefined) {
  return <StatCardGridSkeleton count={3} />;
}

// Disconnected: QB not configured or token expired
if (qbConfig === null || qbConfig.isExpired) {
  return (
    <div className="flex flex-col items-center justify-center py-12 text-muted">
      <svg ... (dollar/plug icon, h-10 w-10, opacity-40) />
      <p className="text-sm mt-3">Connect QuickBooks to see financial data.</p>
      <a href="/admin" className="text-primary hover:underline text-xs mt-2">Configure QuickBooks →</a>
    </div>
  );
}

// Data available — render 3 cards
```

**3 KPI Cards layout (`grid-cols-1 sm:grid-cols-3 gap-4`):**

Per user decision: "3 main KPI cards at top of Executive Snapshot: Cash on Hand, Revenue YTD, Total Expenses"

1. **Cash on Hand** — from `accounts?.data?.totalCash`
   - Icon: credit card / wallet SVG (use existing icon from current component)
   - Color: `text-primary`
   - Value: `formatDollars(amount)` with `title={formatCurrencyExact(amount)}` on the value element (hover tooltip)

2. **Revenue YTD** — from `pnl?.data?.totalRevenue`
   - Icon: trending up arrow SVG (keep existing)
   - Color: `text-success` (green for positive)
   - Value: same compact + hover pattern

3. **Total Expenses** — from `pnl?.data?.totalExpenses` (NEW card — this is what CMD-01 requires)
   - Icon: receipt/arrow-down SVG
   - Color: `text-danger` (red — negative financial signal per user decision "Green/red color coding")
   - Value: same compact + hover pattern

**StatCard modifications:**
Update the existing `StatCard` internal component to support the hover tooltip:
- Add an optional `tooltip?: string` prop
- When tooltip is provided, add `title={tooltip}` and `className="cursor-help"` on the value `<div>`
- Keep existing `loading` prop for backward compat (but the loading state is now handled at the section level with skeleton, so StatCard.loading is unused)

**Updated StatCard usage:**
```tsx
<StatCard
  icon={<svg .../>}
  value={cashOnHand !== null ? formatDollars(cashOnHand) : "--"}
  label="Cash on Hand"
  tooltip={cashOnHand !== null ? formatCurrencyExact(cashOnHand) : undefined}
  accentColor="text-primary"
/>
```

**"Updated X ago" timestamp:**
After the 3-card grid, add a right-aligned timestamp using the most recent `fetchedAt` from either query:
```tsx
{(() => {
  const latest = Math.max(accounts?.fetchedAt ?? 0, pnl?.fetchedAt ?? 0);
  if (latest > 0) {
    return (
      <p className="text-xs text-muted text-right mt-3">
        Updated {timeAgo(latest)}
      </p>
    );
  }
  return null;
})()}
```

**Handle null data gracefully:**
If `accounts?.data` is null (QB connected but never synced), show "--" as value. Same for `pnl?.data`. Don't crash — use optional chaining and nullish coalescing.

**Color coding per user decision:**
- Cash on Hand: neutral primary color (`text-primary`)
- Revenue YTD: green (`text-success`)
- Total Expenses: red (`text-danger`)
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>
    - ExecutiveSnapshot renders 3 KPI cards: Cash on Hand, Revenue YTD, Total Expenses
    - Each card shows compact dollar format with full amount on hover (title attribute)
    - Positive values green, expense values red
    - Shows StatCardGridSkeleton while loading
    - Shows "Connect QuickBooks" prompt when disconnected
    - "Updated X ago" timestamp at bottom
    - No grant imports remain in this component
    - TypeScript compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of complete dashboard</name>
  <what-built>
    Complete Phase 2 dashboard data population:
    - "What Needs Attention" panel at top (grant deadlines + QB status)
    - Executive Snapshot with 3 KPI cards (Cash on Hand, Revenue YTD, Total Expenses)
    - All existing sections (P&L, Grant Budget, Grant Tracking, Donation Performance, Programs) with skeleton loading
    - Client Activity section with per-program breakdown
    - Three-state loading across all sections (skeleton / disconnected / data)
    - Hover tooltips on financial values
    - "Updated X ago" timestamps
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` and `npx convex dev` (if not already running)
    2. Navigate to http://localhost:3000/dashboard
    3. Verify the "What Needs Attention" panel appears at the very top, before any other section
    4. Verify Executive Snapshot shows 3 cards: Cash on Hand, Revenue YTD, Total Expenses
    5. Hover over a dollar value — verify full amount appears in tooltip
    6. Verify Client Activity section appears after P&L section with active/new/total counts and per-program badges
    7. If QuickBooks IS connected: verify real dollar amounts appear (not "--" or "0")
    8. If QuickBooks is NOT connected: verify inline "Connect QuickBooks" prompts appear (not broken/empty states)
    9. Briefly observe page load — sections should show skeleton shimmer blocks before data appears (may be very fast if data is cached)
    10. Verify no console errors in browser DevTools
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. ExecutiveSnapshot shows 3 cards (not 4 grant cards)
3. Each financial value has a `title` attribute for hover tooltip
4. Skeleton shimmer appears during loading (not Spinner)
5. "Connect QuickBooks" prompt when QB null
6. "Updated X ago" timestamp visible
7. WhatNeedsAttention panel visible at top
8. ClientActivity section in reorderable list
9. All sections render independently without breaking each other
</verification>

<success_criteria>
- Kareem opens the dashboard and sees: attention panel, 3 financial KPIs, charts, client activity, programs
- All data comes from live Convex queries (not hardcoded)
- Loading states are skeleton shimmer, not spinners
- Disconnected states show inline prompts, not broken UI
- Human visual verification confirms the dashboard looks correct
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-data-population/02-04-SUMMARY.md`
</output>
