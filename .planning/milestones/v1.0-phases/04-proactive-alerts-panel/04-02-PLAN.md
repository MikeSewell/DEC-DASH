---
phase: 04-proactive-alerts-panel
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/components/dashboard/WhatNeedsAttention.tsx
autonomous: true
requirements:
  - ALRT-01
  - ALRT-02
  - ALRT-03
  - ALRT-04

must_haves:
  truths:
    - "WhatNeedsAttention uses a single useQuery(api.alerts.getAlerts) instead of 3 separate queries"
    - "Alert[] items render in the panel with correct severity styling (critical/warning as amber, info as primary)"
    - "Critical-severity alerts fire a toast notification via useToast() exactly once per alert ID per browser session"
    - "Panel shows skeleton while alerts === undefined, all-clear when alerts is empty array, items when populated"
    - "New alert types (budget, sync) display with appropriate icons alongside existing deadline and integration types"
    - "Panel loads even if some data sources are temporarily unavailable (null-safe query handles gracefully)"
  artifacts:
    - path: "src/components/dashboard/WhatNeedsAttention.tsx"
      provides: "Refactored alerts panel consuming api.alerts.getAlerts"
      contains: "useQuery(api.alerts.getAlerts)"
  key_links:
    - from: "src/components/dashboard/WhatNeedsAttention.tsx"
      to: "convex/alerts.ts"
      via: "useQuery(api.alerts.getAlerts)"
      pattern: "useQuery.*api\\.alerts\\.getAlerts"
    - from: "src/components/dashboard/WhatNeedsAttention.tsx"
      to: "src/components/ui/Toast.tsx"
      via: "useToast() for critical alert toasts"
      pattern: "useToast.*toast.*critical"
---

<objective>
Refactor `WhatNeedsAttention.tsx` to consume the single `api.alerts.getAlerts` query from Plan 04-01, replacing the current 3-query fan-out. Add toast notifications for critical alerts using the existing `useToast()` system. Add icons for new alert types (budget, sync).

Purpose: Completes the proactive alerts panel — Kareem sees all alert types in one ranked panel and gets notified of critical items via toast.

Output: Refactored `WhatNeedsAttention.tsx` with single query, expanded alert types, and toast integration.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-proactive-alerts-panel/04-RESEARCH.md
@.planning/phases/04-proactive-alerts-panel/04-01-SUMMARY.md

<interfaces>
<!-- Key types from Plan 04-01 output that this plan consumes -->

From convex/alerts.ts (created in 04-01):
```typescript
export interface Alert {
  id: string;
  type: "deadline" | "budget" | "sync" | "integration";
  severity: "critical" | "warning" | "info";
  title: string;
  description: string;
  action?: { label: string; href: string };
  urgencyScore: number;
}

export const getAlerts: query  // returns Alert[]
```

From src/components/ui/Toast.tsx:
```typescript
type ToastVariant = "success" | "error" | "warning" | "info";

interface ToastInput {
  title: string;
  description?: string;
  variant: ToastVariant;
}

interface ToastContextValue {
  toasts: ToastData[];
  toast: (input: ToastInput) => void;
  dismiss: (id: string) => void;
}

export function useToast(): ToastContextValue;
```

From src/components/dashboard/WhatNeedsAttention.tsx (current — will be replaced):
```typescript
interface AttentionItem {
  id: string;
  type: "deadline" | "integration" | "info";
  severity: "warning" | "info" | "success";
  title: string;
  description: string;
  action?: { label: string; href: string };
}

// Currently uses 3 queries:
// useQuery(api.grants.getUpcomingDeadlines)
// useQuery(api.quickbooks.getConfig)
// useQuery(api.grants.getStats)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor WhatNeedsAttention to use single alerts query with toast notifications</name>
  <files>src/components/dashboard/WhatNeedsAttention.tsx</files>
  <action>
Rewrite `src/components/dashboard/WhatNeedsAttention.tsx` to consume `api.alerts.getAlerts`. This is a refactor of the existing component, not a new file.

**1. Update imports:**
Remove:
- `import { formatDate } from "@/lib/utils";` (no longer needed — alerts.ts handles date formatting in description)

Add:
- `import { useToast } from "@/components/ui/Toast";`
- `import { useEffect, useRef } from "react";`

Keep:
- `import { useQuery } from "convex/react";`
- `import { api } from "../../../convex/_generated/api";`
- `import { ListSkeleton } from "@/components/dashboard/skeletons/TableSkeleton";`

Import the Alert type:
- `import type { Alert } from "../../../convex/alerts";`

**2. Update the AttentionItem type — REMOVE it.**
The component now uses `Alert` from `convex/alerts.ts` directly. The type mapping is:
- Alert.type includes `"deadline" | "budget" | "sync" | "integration"` (expanded from the old 3)
- Alert.severity includes `"critical" | "warning" | "info"` (replaces old "success" — no success alerts in this panel)

**3. Update severityStyles — expand to handle "critical":**
```typescript
const severityStyles: Record<Alert["severity"], string> = {
  critical: "border-l-4 border-red-400 bg-red-50/50 dark:bg-red-950/20",
  warning: "border-l-4 border-amber-400 bg-amber-50/50 dark:bg-amber-950/20",
  info: "border-l-4 border-primary bg-primary/5",
};
```

**4. Update severityIconColors:**
```typescript
const severityIconColors: Record<Alert["severity"], string> = {
  critical: "text-red-500",
  warning: "text-amber-500",
  info: "text-primary",
};
```

**5. Add icons for new types — budget and sync:**

Add a `ChartBarIcon` for budget alerts:
```typescript
function ChartBarIcon() {
  return (
    <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
    </svg>
  );
}
```

Add a `RefreshIcon` for sync alerts:
```typescript
function RefreshIcon() {
  return (
    <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182M2.985 19.644l3.181-3.182" />
    </svg>
  );
}
```

**6. Update ItemIcon to handle all 4 types:**
```typescript
function ItemIcon({ type }: { type: Alert["type"] }) {
  if (type === "deadline") return <CalendarIcon />;
  if (type === "integration") return <PlugIcon />;
  if (type === "budget") return <ChartBarIcon />;
  if (type === "sync") return <RefreshIcon />;
  return <CalendarIcon />; // fallback
}
```

**7. Rewrite the component body:**

Replace the 3 `useQuery` calls and manual item building with:

```typescript
export default function WhatNeedsAttention() {
  const alerts = useQuery(api.alerts.getAlerts);
  const { toast } = useToast();
  const toastedIds = useRef(new Set<string>());
  const isLoading = alerts === undefined;

  // Fire toast for critical alerts — once per ID per browser session
  useEffect(() => {
    if (!alerts) return;
    for (const alert of alerts) {
      if (alert.severity === "critical" && !toastedIds.current.has(alert.id)) {
        toastedIds.current.add(alert.id);
        toast({
          title: alert.title,
          description: alert.description,
          variant: "warning",   // Toast system uses "warning" for amber styling
        });
      }
    }
  }, [alerts, toast]);

  // ... rest of render (keep existing JSX structure)
}
```

**8. Update the render section:**
- Replace `items.map(...)` with `alerts.map(...)` (the shape is the same — id, type, severity, title, description, action)
- Replace `items.length` badge with `alerts.length`
- Replace `items.length === 0` all-clear check with `alerts.length === 0`
- Use `severityStyles[alert.severity]` and `severityIconColors[alert.severity]` (Alert severity type now matches the style maps)

**CRITICAL pitfall avoidance:**
- `useRef<Set<string>>` to deduplicate toasts — do NOT toast on every render cycle
- Toast `variant: "warning"` (not "critical" — Toast.tsx ToastVariant type does not have "critical", only success/error/warning/info). Use "warning" for critical alerts (amber styling is appropriate).
- `alerts === undefined` is the loading state, `alerts` being an empty array `[]` is the all-clear state — different from the old 3-query pattern where undefined meant ANY query still loading
- Keep all existing SVG icon components (BellIcon, CalendarIcon, PlugIcon, CheckCircleIcon) — just add ChartBarIcon and RefreshIcon
- Keep the same panel shell JSX (rounded-2xl card, header with bell icon, body with skeleton/all-clear/items)
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit src/components/dashboard/WhatNeedsAttention.tsx 2>&1 | head -20</automated>
  </verify>
  <done>WhatNeedsAttention.tsx uses single useQuery(api.alerts.getAlerts), renders all 4 alert types with correct icons and severity styles, fires toast for critical alerts via useRef dedup guard. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end build and panel rendering</name>
  <files>src/components/dashboard/WhatNeedsAttention.tsx</files>
  <action>
Run the full Next.js build to verify no TypeScript or import errors across the entire application:

```bash
cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npm run build
```

Check for:
1. No TypeScript errors in WhatNeedsAttention.tsx
2. No import resolution failures (api.alerts.getAlerts must exist in generated types)
3. No unused import warnings that would fail the build
4. No errors in other files that import from WhatNeedsAttention (dashboard/page.tsx)

If the build fails due to the `api.alerts` module not being in generated types (because `npx convex dev --once` wasn't run), verify TypeScript compilation of just the component file works, and note the Convex deployment as a prerequisite in the summary.

Also verify the old queries (`api.grants.getUpcomingDeadlines`, `api.quickbooks.getConfig`, `api.grants.getStats`) are NO LONGER imported in WhatNeedsAttention.tsx — they should only be used elsewhere in the codebase (grants page, etc.), not in this component.
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npm run build 2>&1 | tail -10</automated>
  </verify>
  <done>Full Next.js build passes. WhatNeedsAttention.tsx has zero old query imports (getUpcomingDeadlines, getConfig, getStats not referenced). Dashboard page renders WhatNeedsAttention without errors.</done>
</task>

</tasks>

<verification>
1. `WhatNeedsAttention.tsx` imports and calls `useQuery(api.alerts.getAlerts)` — verified by grep
2. No references to `api.grants.getUpcomingDeadlines`, `api.quickbooks.getConfig`, or `api.grants.getStats` remain in the file
3. `useToast()` imported and used with `useRef<Set<string>>` deduplication guard
4. Critical alerts fire toast exactly once per ID (ref persists across re-renders)
5. 4 alert types have icons: deadline (CalendarIcon), integration (PlugIcon), budget (ChartBarIcon), sync (RefreshIcon)
6. 3 severity levels styled: critical (red), warning (amber), info (primary/teal)
7. `npm run build` passes
</verification>

<success_criteria>
- WhatNeedsAttention panel shows alerts from a single Convex query (not 3 separate queries)
- All 4 alert types render with appropriate icons and severity styling
- Critical alerts trigger a toast notification once per browser session
- Panel gracefully handles loading (skeleton), empty (all-clear), and populated states
- Full Next.js build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-proactive-alerts-panel/04-02-SUMMARY.md`
</output>
