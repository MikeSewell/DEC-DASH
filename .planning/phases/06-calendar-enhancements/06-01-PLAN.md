---
phase: 06-calendar-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/constants.ts
  - src/components/dashboard/CalendarWidget.tsx
autonomous: true
requirements:
  - CAL-01
  - CAL-02
  - CAL-03

must_haves:
  truths:
    - "Calendar events display a colored type chip/badge indicating their category — client sessions, board meetings, community events, and grant deadlines each have a visually distinct color"
    - "Event type is classified by keyword matching on the event summary (title) and calendarDisplayName — no schema changes required"
    - "Events starting within 2 hours show a live countdown badge (e.g. 'in 47 min', 'in 1h 23m') that updates every 60 seconds without page refresh"
    - "Countdown badges disappear once the event has started or is more than 2 hours away"
    - "When the dashboard loads and an event starts within 30-60 minutes, a toast notification fires once per session per event using the existing useToast system"
    - "Toast notifications do NOT re-fire on re-renders or data refetches — dedup via useRef Set keyed by eventId"
    - "Color coding and countdown badges render correctly with both existing dark and light theme CSS variables (using Tailwind theme colors, not hardcoded hex)"
    - "When no events are present or calendar is not configured, no errors occur from countdown timers or toast logic"
  artifacts:
    - path: "src/lib/constants.ts"
      provides: "EVENT_TYPE_CONFIG mapping keyword patterns to type labels and colors"
      contains: "EVENT_TYPE_CONFIG"
    - path: "src/components/dashboard/CalendarWidget.tsx"
      provides: "Enhanced CalendarWidget with type badges, countdown badges, and imminent event toasts"
      contains: "classifyEventType"
  key_links:
    - from: "src/components/dashboard/CalendarWidget.tsx"
      to: "src/lib/constants.ts"
      via: "imports EVENT_TYPE_CONFIG for event type classification"
      pattern: "EVENT_TYPE_CONFIG"
    - from: "src/components/dashboard/CalendarWidget.tsx"
      to: "src/components/ui/Toast.tsx"
      via: "useToast hook for imminent event notifications"
      pattern: "useToast"
    - from: "src/components/dashboard/CalendarWidget.tsx"
      to: "convex/googleCalendar.ts"
      via: "useCalendarEvents hook providing events with summary and startAt fields"
      pattern: "useCalendarEvents"
---

<objective>
Enhance the CalendarWidget with event type color coding, live countdown badges for imminent events, and toast notifications for events starting within 30-60 minutes.

Purpose: Kareem can scan upcoming commitments at a glance — event types are visually distinct by color, urgency is immediately readable via countdown badges, and imminent events trigger a toast so nothing is missed.

Output: CalendarWidget.tsx displays colored type chips per event, live-updating countdown badges for events within 2 hours, and fires toast notifications for events in the 30-60 minute window on dashboard load.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/dashboard/CalendarWidget.tsx
@src/lib/constants.ts
@src/components/ui/Toast.tsx
@src/hooks/useGoogleCalendar.ts
@convex/googleCalendar.ts
@convex/schema.ts
@src/app/globals.css

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/components/dashboard/CalendarWidget.tsx — CalendarEvent shape (from googleCalendarCache table):
```typescript
interface CalendarEvent {
  _id: string;
  eventId: string;
  calendarId: string;
  calendarDisplayName: string;
  summary: string;       // Event title — used for type classification
  startAt: number;       // Unix ms timestamp
  endAt: number;         // Unix ms timestamp
  isAllDay: boolean;
  location?: string;
  htmlLink?: string;
}
```

From src/components/ui/Toast.tsx — Toast API:
```typescript
type ToastVariant = "success" | "error" | "warning" | "info";

interface ToastInput {
  title: string;
  description?: string;
  variant: ToastVariant;
}

// Usage: const { toast } = useToast();
// toast({ title: "...", description: "...", variant: "info" });
```

From src/lib/constants.ts — existing calendar colors (currently used for calendar source dots):
```typescript
export const CALENDAR_DOT_COLORS = [
  "#1B5E6B", "#6BBF59", "#2B9E9E", "#8CC63F", "#5BBFB5", "#1A7A7A",
] as const;
```

From src/app/globals.css — CSS variables available for theming:
```css
:root {
  --primary: #2D6A4F;
  --accent: #8CC63F;
  --success: #40916C;
  --warning: #C07B28;
  --danger: #C2432A;
  --muted: #6B846E;
}
.dark {
  --primary: #52B788;
  --accent: #8CC63F;
  --success: #52B788;
  --warning: #f59e0b;
  --danger: #ef4444;
  --muted: #8AAB8E;
}
```

From WhatNeedsAttention.tsx — toast dedup pattern (proven pattern to reuse):
```typescript
const { toast } = useToast();
const toastedIds = useRef(new Set<string>());

useEffect(() => {
  if (!alerts) return;
  for (const alert of alerts) {
    if (alert.severity === "critical" && !toastedIds.current.has(alert.id)) {
      toastedIds.current.add(alert.id);
      toast({ title: alert.title, description: alert.description, variant: "warning" });
    }
  }
}, [alerts, toast]);
```

Design system patterns (from globals.css and CLAUDE.md):
- Pill-shaped buttons: `rounded-full`
- Cards: `rounded-2xl`
- Badge styling: `text-xs px-1.5 py-0.5 rounded-full bg-primary/10 text-primary font-medium`
- Theme-safe coloring: use Tailwind classes referencing CSS variables (e.g. `text-primary`, `bg-primary/10`) rather than hardcoded hex
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event type classification config and render type badges + countdown badges</name>
  <files>src/lib/constants.ts, src/components/dashboard/CalendarWidget.tsx</files>
  <action>
**1. Add EVENT_TYPE_CONFIG to `src/lib/constants.ts`:**

Add a new export after the existing `CALENDAR_DOT_COLORS` constant. This config maps event types to keyword patterns and Tailwind-safe color classes. The classification algorithm will match event `summary` (title) and `calendarDisplayName` against these patterns.

```typescript
export interface EventTypeConfig {
  label: string;
  keywords: string[];       // Lowercase substrings to match against summary + calendarDisplayName
  bgClass: string;          // Tailwind bg class for the badge
  textClass: string;        // Tailwind text class for the badge
  dotColor: string;         // Hex color for the left-border indicator (replaces calendar-source dot)
}

export const EVENT_TYPE_CONFIG: Record<string, EventTypeConfig> = {
  client: {
    label: "Client",
    keywords: ["client", "session", "intake", "co-parent", "coparent", "legal clinic", "consultation", "counseling", "father"],
    bgClass: "bg-primary/10",
    textClass: "text-primary",
    dotColor: "var(--primary)",
  },
  board: {
    label: "Board",
    keywords: ["board", "director", "governance", "trustee", "advisory"],
    bgClass: "bg-accent/15",
    textClass: "text-accent",
    dotColor: "var(--accent)",
  },
  community: {
    label: "Community",
    keywords: ["community", "outreach", "workshop", "event", "fundrais", "gala", "volunteer", "open house", "webinar", "training"],
    bgClass: "bg-warning/10",
    textClass: "text-warning",
    dotColor: "var(--warning)",
  },
  grant: {
    label: "Grant",
    keywords: ["grant", "report due", "funder", "proposal", "deadline", "submission"],
    bgClass: "bg-danger/10",
    textClass: "text-danger",
    dotColor: "var(--danger)",
  },
  general: {
    label: "Event",
    keywords: [],  // Fallback — matches everything not caught above
    bgClass: "bg-muted/10",
    textClass: "text-muted",
    dotColor: "var(--muted)",
  },
};
```

**2. Add `classifyEventType` helper to `CalendarWidget.tsx`:**

At the top of CalendarWidget.tsx, after the imports, add a helper function that classifies events:

```typescript
import { CALENDAR_DOT_COLORS, EVENT_TYPE_CONFIG, type EventTypeConfig } from "@/lib/constants";

function classifyEventType(event: CalendarEvent): EventTypeConfig {
  const haystack = `${event.summary} ${event.calendarDisplayName}`.toLowerCase();
  for (const [key, config] of Object.entries(EVENT_TYPE_CONFIG)) {
    if (key === "general") continue; // Check fallback last
    if (config.keywords.some((kw) => haystack.includes(kw))) {
      return config;
    }
  }
  return EVENT_TYPE_CONFIG.general;
}
```

**3. Add countdown helper to CalendarWidget.tsx:**

Add a `formatCountdown` function that returns a human-readable countdown string for events within 2 hours, or `null` if outside that window:

```typescript
function formatCountdown(startAt: number, now: number): string | null {
  const diffMs = startAt - now;
  if (diffMs <= 0 || diffMs > 2 * 60 * 60 * 1000) return null; // Past or >2h away
  const totalMin = Math.ceil(diffMs / 60000);
  if (totalMin <= 60) return `in ${totalMin} min`;
  const hours = Math.floor(totalMin / 60);
  const mins = totalMin % 60;
  return mins > 0 ? `in ${hours}h ${mins}m` : `in ${hours}h`;
}
```

**4. Add a `useNow` timer for live countdown updates:**

Inside the CalendarWidget component (after the existing `useCalendarEvents` and `useState` hooks), add a state-based timer that updates `now` every 60 seconds. This drives the countdown badges to update without page refresh:

```typescript
const [now, setNow] = useState(Date.now());

useEffect(() => {
  const interval = setInterval(() => setNow(Date.now()), 60_000);
  return () => clearInterval(interval);
}, []);
```

Remove the existing `const now = Date.now();` line that was computed inline (line ~185 currently). Replace all references to that `now` with the state-based one. The `today` variable can stay as `new Date()` since it's only used for day labels (doesn't need 60s refresh).

**5. Update the EventRow component to display type badge and countdown badge:**

Modify the `EventRow` component to accept the classified event type and current time, then render:
- A colored type chip badge next to the event title
- A countdown badge when the event is within 2 hours

Update the `EventRowProps` interface:
```typescript
interface EventRowProps {
  event: CalendarEvent;
  eventType: EventTypeConfig;
  now: number;
}
```

Remove the `color` prop — the event type config now drives all coloring.

Inside EventRow, replace the calendar-source dot/name section on the right side with the type badge. Add the countdown badge. The new layout for each event row should be:

```
[Time] [Type Badge] [Event Title + Location] [Countdown Badge (if within 2h)]
```

Specifically, update the EventRow JSX. The currently-happening left border should use `eventType.dotColor` instead of the old `color` prop. Replace the content column and right column:

```tsx
function EventRow({ event, eventType, now }: EventRowProps) {
  const isHappening = !event.isAllDay && now >= event.startAt && now < event.endAt;
  const countdown = !event.isAllDay ? formatCountdown(event.startAt, now) : null;

  const rowContent = (
    <div
      className={`flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/5 transition-colors ${
        isHappening ? "border-l-4" : ""
      }`}
      style={isHappening ? { borderLeftColor: eventType.dotColor } : undefined}
    >
      {/* Time column */}
      <div className="w-16 shrink-0 text-xs text-muted">
        {event.isAllDay ? (
          <span className="italic">All day</span>
        ) : (
          formatTime(event.startAt)
        )}
      </div>

      {/* Type badge */}
      <span className={`shrink-0 text-[10px] font-semibold px-1.5 py-0.5 rounded-full ${eventType.bgClass} ${eventType.textClass}`}>
        {eventType.label}
      </span>

      {/* Content column */}
      <div className="flex-1 min-w-0">
        <p className="text-sm font-medium text-foreground truncate">{event.summary}</p>
        {event.location && (
          <p className="text-xs text-muted truncate">{event.location}</p>
        )}
      </div>

      {/* Countdown badge — only when within 2 hours */}
      {countdown && (
        <span className="shrink-0 text-[10px] font-semibold px-2 py-0.5 rounded-full bg-warning/15 text-warning tabular-nums animate-pulse">
          {countdown}
        </span>
      )}
    </div>
  );

  if (event.htmlLink) {
    return (
      <a href={event.htmlLink} target="_blank" rel="noopener noreferrer" className="block">
        {rowContent}
      </a>
    );
  }

  return rowContent;
}
```

**6. Update CalendarWidget main component to use new EventRow props:**

In the main `CalendarWidget` component rendering loop, replace the `color` prop computation with event type classification:

Before (current code):
```tsx
const color = calendarColorMap[event.calendarId] ?? CALENDAR_DOT_COLORS[0];
// ...
<EventRow event={event} color={color} now={now} />
```

After:
```tsx
const eventType = classifyEventType(event);
// ...
<EventRow event={event} eventType={eventType} now={now} />
```

Remove the `calendarColorMap` construction code (the `uniqueCalendarIds` and `Object.fromEntries` block) since we no longer color by calendar source — we now color by event type.

Also remove the now-unused `CALENDAR_DOT_COLORS` import if it's no longer referenced anywhere in this file (keep it exported from constants.ts in case other code uses it).
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - EVENT_TYPE_CONFIG exported from constants.ts with 5 event types (client, board, community, grant, general fallback)
    - classifyEventType helper matches event summary + calendarDisplayName against keyword patterns
    - Each event row displays a colored type badge (pill-shaped) indicating its category
    - Events within 2 hours show a pulsing countdown badge (e.g. "in 47 min", "in 1h 23m")
    - Countdown updates every 60 seconds via setInterval without page refresh
    - Currently-happening events still show left border indicator, now using type color
    - All colors use CSS variable references (var(--primary), etc.) so they work in both light and dark themes
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add toast notifications for events starting within 30-60 minutes</name>
  <files>src/components/dashboard/CalendarWidget.tsx</files>
  <action>
**1. Import `useToast` and add toast dedup ref:**

Add the `useToast` import to CalendarWidget.tsx:
```typescript
import { useToast } from "@/components/ui/Toast";
```

Inside the CalendarWidget component, after the existing hooks, add:
```typescript
const { toast } = useToast();
const toastedEventIds = useRef(new Set<string>());
```

Add `useRef` to the React imports at the top of the file (alongside the existing `useState`):
```typescript
import { useState, useEffect, useRef } from "react";
```

**2. Add imminent event toast effect:**

After the `useEffect` for the 60-second timer (added in Task 1), add a new `useEffect` that checks for events starting within 30-60 minutes and fires toasts:

```typescript
// Toast for imminent events (30-60 min window) — fires once per event per session
useEffect(() => {
  if (!result || result === null) return;
  const events = result.events as CalendarEvent[];

  for (const event of events) {
    if (event.isAllDay) continue;
    const diffMs = event.startAt - now;
    const diffMin = diffMs / 60000;

    // Only toast for events starting in 30-60 minutes
    if (diffMin < 30 || diffMin > 60) continue;

    // Dedup: only fire once per event per session
    if (toastedEventIds.current.has(event.eventId)) continue;
    toastedEventIds.current.add(event.eventId);

    const eventType = classifyEventType(event);
    const minutesAway = Math.round(diffMin);

    toast({
      title: `${eventType.label} in ${minutesAway} min`,
      description: event.summary,
      variant: "info",
    });
  }
}, [result, now, toast]);
```

**Key behavior notes:**
- The effect depends on `now` (which updates every 60 seconds from the interval in Task 1), so it will re-evaluate as time passes. However, the `toastedEventIds` ref prevents duplicate toasts.
- The 30-60 minute window means: if Kareem opens the dashboard and an event is 45 minutes away, he gets a toast. If he opens it when the event is 20 minutes away (already past the window), no toast fires — the countdown badge is sufficient.
- All-day events are excluded from toasts (they have no specific start time).
- The `eventId` key (from Google Calendar) ensures uniqueness even across data refetches.
- The ref persists across re-renders but resets on page navigation (new component mount), which is the correct "once per session" behavior matching the WhatNeedsAttention pattern.

**3. Verify the toast fires correctly with the existing ToastProvider:**

The CalendarWidget renders inside the dashboard page, which is inside the layout that wraps everything in `<ToastProvider>`. No changes needed to the provider — it's already in place (same provider used by WhatNeedsAttention).

**4. Guard against empty/null states:**

The toast effect already has `if (!result || result === null) return;` as its first line, which handles:
- `result === undefined` (still loading) — no toasts fire during loading
- `result === null` (calendar not configured) — no toasts fire
- Empty events array — the for loop simply doesn't execute

No additional guards needed.
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - When dashboard loads with events starting in 30-60 minutes, a toast notification fires with event type label, countdown, and event title
    - Toast fires exactly once per event per session (useRef Set dedup on eventId)
    - Toast does NOT fire for all-day events
    - Toast does NOT fire for events outside the 30-60 minute window
    - No errors when calendar is not configured or has no events
    - Toast uses the existing useToast system (info variant) — no new toast library needed
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (confirms no runtime import issues)
3. Visual verification: Calendar events display colored type badges — client sessions (teal), board meetings (green), community events (amber), grant deadlines (red), general (muted)
4. Visual verification: Events within 2 hours show a pulsing countdown badge (e.g. "in 47 min") that updates every 60 seconds
5. Visual verification: Countdown badges disappear once event starts or is more than 2 hours away
6. Visual verification: When an event is 30-60 minutes away on dashboard load, a toast notification appears with event type and title
7. Visual verification: Toast does NOT re-appear on subsequent renders or data refetches
8. Visual verification: Colors and badges display correctly in both light and dark theme
9. Edge case: When calendar is not configured, no errors or stray toasts
10. Edge case: When no events exist, widget shows empty state without errors
</verification>

<success_criteria>
- Calendar events display color-coded type badges (CAL-01)
- Imminent events show live countdown badges that update without page refresh (CAL-02)
- Toast notification fires for events starting within 30-60 min when dashboard loads, once per session per event (CAL-03)
- All visual elements work correctly in both dark and light themes
- No errors in empty/unconfigured states
- No new npm dependencies required
</success_criteria>

<output>
After completion, create `.planning/phases/06-calendar-enhancements/06-01-SUMMARY.md`
</output>
