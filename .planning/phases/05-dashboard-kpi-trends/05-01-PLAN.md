---
phase: 05-dashboard-kpi-trends
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/quickbooksActions.ts
  - convex/quickbooks.ts
  - src/hooks/useQuickBooks.ts
  - src/components/dashboard/ExecutiveSnapshot.tsx
autonomous: true
requirements:
  - DASH-01
  - DASH-02

must_haves:
  truths:
    - "Each KPI card (Cash on Hand, Revenue YTD, Total Expenses) shows a directional arrow and percentage change when QB historical data exists"
    - "Trend percentage compares current month vs same month in the prior year from QB P&L data"
    - "When QB is not connected, KPI cards render normally without trend indicators — no errors, no empty trend badges"
    - "When prior-year data is unavailable (new QB connection, no history), KPI cards render without trend indicators — graceful null fallback"
    - "Trend indicators show skeleton shimmer while loading, not a flash of no-trend then trend appearing"
  artifacts:
    - path: "convex/quickbooksActions.ts"
      provides: "Prior-year P&L fetch action + sync integration"
      contains: "fetchPriorYearPnl"
    - path: "convex/quickbooks.ts"
      provides: "Trend computation query"
      exports: ["getTrends"]
    - path: "src/hooks/useQuickBooks.ts"
      provides: "React hook for trend data"
      exports: ["useTrends"]
    - path: "src/components/dashboard/ExecutiveSnapshot.tsx"
      provides: "KPI cards with trend arrows and percentages"
      contains: "useTrends"
  key_links:
    - from: "convex/quickbooksActions.ts"
      to: "convex/quickbooksInternal.ts"
      via: "cacheReport mutation with reportType 'profit_loss_prior_year'"
      pattern: "cacheReport.*profit_loss_prior_year"
    - from: "convex/quickbooks.ts"
      to: "quickbooksCache table"
      via: "reads both 'profit_loss' and 'profit_loss_prior_year' cache entries"
      pattern: "by_reportType.*profit_loss_prior_year"
    - from: "src/components/dashboard/ExecutiveSnapshot.tsx"
      to: "convex/quickbooks.ts"
      via: "useTrends hook calling api.quickbooks.getTrends"
      pattern: "useTrends"
---

<objective>
Add year-over-year trend indicators to the dashboard KPI cards (Cash on Hand, Revenue YTD, Total Expenses) using QuickBooks historical P&L data.

Purpose: Kareem can see at a glance whether key financial metrics are improving or declining compared to the same month last year, without digging into QB reports.

Output: KPI cards display directional arrows (up/green or down/red) with percentage change values, computed from cached QB P&L data for current month vs same month in the prior year. Graceful fallback when data is unavailable.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@convex/quickbooksActions.ts
@convex/quickbooks.ts
@convex/quickbooksInternal.ts
@convex/schema.ts
@src/hooks/useQuickBooks.ts
@src/components/dashboard/ExecutiveSnapshot.tsx
@src/components/dashboard/skeletons/StatCardSkeleton.tsx

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From convex/quickbooks.ts — existing getProfitAndLoss return shape:
```typescript
// Returns null if no cache, or:
{
  data: {
    totalRevenue: number;
    totalExpenses: number;  // Math.abs'd
    netIncome: number;
    revenueByCategory: Record<string, number>;
    expensesByCategory: Record<string, number>;
    period: { start: string; end: string };
  };
  fetchedAt: number;
}
```

From convex/quickbooksActions.ts — existing fetch pattern:
```typescript
// fetchProfitAndLoss accepts optional date range
export const fetchProfitAndLoss = internalAction({
  args: { startDate: v.optional(v.string()), endDate: v.optional(v.string()) },
  handler: async (ctx, args) => {
    // Uses getAuthenticatedConfig(ctx) for token + realmId
    // Caches via internal.quickbooksInternal.cacheReport with reportType: "profit_loss"
  },
});
```

From convex/quickbooksInternal.ts — cache mutation:
```typescript
export const cacheReport = internalMutation({
  args: {
    reportType: v.string(),        // e.g. "profit_loss", "expenses", etc.
    data: v.string(),               // JSON stringified QB response
    periodStart: v.optional(v.string()),
    periodEnd: v.optional(v.string()),
  },
  // Deletes existing cache for reportType, inserts new
});
```

From convex/quickbooksActions.ts — syncAllData calls each fetch sequentially:
```typescript
export const syncAllData = internalAction({
  handler: async (ctx) => {
    await ctx.runAction(internal.quickbooksActions.fetchProfitAndLoss, {});
    await ctx.runAction(internal.quickbooksActions.fetchExpenses, {});
    // ... other fetches
  },
});
```

From src/components/dashboard/ExecutiveSnapshot.tsx — StatCard already accepts trend:
```typescript
interface StatCardProps {
  icon: React.ReactNode;
  value: string;
  label: string;
  trend?: { value: string; positive: boolean } | null;
  accentColor?: string;
  tooltip?: string;
}
```

From src/hooks/useQuickBooks.ts — existing hook pattern:
```typescript
export function useProfitAndLoss() {
  return useQuery(api.quickbooks.getProfitAndLoss);
}
```

Three-state loading pattern (from v1.0):
- `undefined` = query still loading (show skeleton)
- `null` = no data / not configured (show empty state or hide)
- `{data}` = ready to render
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prior-year P&L fetch and trend computation query</name>
  <files>convex/quickbooksActions.ts, convex/quickbooks.ts, src/hooks/useQuickBooks.ts</files>
  <action>
**1. Add `fetchPriorYearPnl` action in `convex/quickbooksActions.ts`:**

Create a new `internalAction` called `fetchPriorYearPnl` that fetches the P&L report for the same month in the prior year. Place it after the existing `fetchProfitAndLoss` action.

```typescript
export const fetchPriorYearPnl = internalAction({
  handler: async (ctx) => {
    const { accessToken, realmId } = await getAuthenticatedConfig(ctx);
    const baseUrl = getBaseUrl();

    const now = new Date();
    const priorYear = now.getFullYear() - 1;
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const lastDay = new Date(priorYear, now.getMonth() + 1, 0).getDate();
    const startDate = `${priorYear}-${month}-01`;
    const endDate = `${priorYear}-${month}-${String(lastDay).padStart(2, "0")}`;

    const response = await fetch(
      `${baseUrl}/v3/company/${realmId}/reports/ProfitAndLoss?start_date=${startDate}&end_date=${endDate}&minorversion=65`,
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          Accept: "application/json",
        },
      }
    );

    if (!response.ok) throw new Error(`QB API error: ${response.status}`);
    const data = await response.json();

    await ctx.runMutation(internal.quickbooksInternal.cacheReport, {
      reportType: "profit_loss_prior_year",
      data: JSON.stringify(data),
      periodStart: startDate,
      periodEnd: endDate,
    });
  },
});
```

**2. Add `fetchPriorYearPnl` to `syncAllData` in `convex/quickbooksActions.ts`:**

Add `await ctx.runAction(internal.quickbooksActions.fetchPriorYearPnl, {});` right after the `fetchProfitAndLoss` call in the `syncAllData` handler. This ensures prior-year data refreshes every 15 minutes alongside the current P&L.

**3. Create `getTrends` query in `convex/quickbooks.ts`:**

Add a new exported query called `getTrends` that:
- Reads both `profit_loss` and `profit_loss_prior_year` from `quickbooksCache`
- Parses both using the same extraction logic already in `getProfitAndLoss` (the `extractCategories` helper and row-parsing loop)
- Computes percentage change for totalRevenue, totalExpenses, and netIncome
- Returns `null` if either cache entry is missing (graceful fallback)
- Returns an object with trend data when both exist

Return type:
```typescript
// Returns null if prior-year data unavailable, or:
{
  revenue: { pctChange: number; positive: boolean } | null;
  expenses: { pctChange: number; positive: boolean } | null;
  // Note: Cash on Hand trend not included — it's a point-in-time balance from the accounts
  // query, not a P&L figure. There's no meaningful "same month last year" comparison for bank balances.
  fetchedAt: number;
}
```

For the percentage calculation: `pctChange = ((current - prior) / Math.abs(prior)) * 100`. If prior is 0, return `null` for that metric (avoid division by zero). Round to 1 decimal place.

For `positive`:
- Revenue: positive = true when current > prior (more revenue is good)
- Expenses: positive = true when current < prior (less expenses is good — INVERTED logic)

IMPORTANT: Extract the P&L parsing logic into a reusable helper function (e.g. `parsePnlTotals`) that both `getProfitAndLoss` and `getTrends` can call, to avoid code duplication. This helper takes the raw JSON data string and returns `{ totalRevenue, totalExpenses, netIncome }`.

**4. Add `useTrends` hook in `src/hooks/useQuickBooks.ts`:**

```typescript
export function useTrends() {
  return useQuery(api.quickbooks.getTrends);
}
```

Place it after the existing `useProfitAndLoss` hook.
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - `fetchPriorYearPnl` action exists and is called in `syncAllData`
    - `getTrends` query reads both cache entries and computes percentage changes
    - `useTrends` hook exported from useQuickBooks.ts
    - TypeScript compiles without errors
    - P&L parsing logic is shared between `getProfitAndLoss` and `getTrends` (no duplication)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire trend data into KPI cards with graceful loading states</name>
  <files>src/components/dashboard/ExecutiveSnapshot.tsx</files>
  <action>
**Update `ExecutiveSnapshot.tsx` to display trend indicators on KPI cards.**

1. **Import `useTrends`** from `@/hooks/useQuickBooks` alongside the existing imports.

2. **Call `useTrends()`** inside the `ExecutiveSnapshot` component, alongside existing hooks:
```typescript
const trends = useTrends();
```

3. **Update loading state** to include trends in the three-state check. The loading skeleton should show while ANY financial data is still loading. Update the existing loading check:
```typescript
if (qbConfig === undefined || accounts === undefined || pnl === undefined || trends === undefined) {
```
This ensures the skeleton shows until trends are also loaded, preventing a flash where KPI cards appear without trends then suddenly get trend badges.

4. **Compute trend props** for each card after the existing value extraction:
```typescript
// Trend indicators (null if no prior-year data available)
const revenueTrend = trends?.revenue
  ? { value: `${Math.abs(trends.revenue.pctChange).toFixed(1)}% vs last year`, positive: trends.revenue.positive }
  : null;

const expensesTrend = trends?.expenses
  ? { value: `${Math.abs(trends.expenses.pctChange).toFixed(1)}% vs last year`, positive: trends.expenses.positive }
  : null;
```

Note: Cash on Hand does NOT get a trend — it's a point-in-time balance, not a P&L metric. Leave it without a trend prop as it is now.

5. **Pass trend props** to the Revenue YTD and Total Expenses StatCards:
- Revenue YTD card: `trend={revenueTrend}`
- Total Expenses card: `trend={expensesTrend}`
- Cash on Hand card: no `trend` prop (unchanged)

6. **Enhance the trend display in the StatCard component** to include a directional arrow before the percentage text. Update the trend rendering inside `StatCard`:

Replace the existing trend rendering block:
```tsx
{trend && (
  <p
    className={cn(
      "text-xs mt-1 font-medium",
      trend.positive ? "text-success" : "text-danger"
    )}
  >
    {trend.positive ? "+" : ""}
    {trend.value}
  </p>
)}
```

With:
```tsx
{trend && (
  <p
    className={cn(
      "text-xs mt-1 font-medium inline-flex items-center gap-1",
      trend.positive ? "text-success" : "text-danger"
    )}
  >
    <svg
      className="h-3 w-3"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      strokeWidth={2.5}
    >
      {trend.positive ? (
        <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
      ) : (
        <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 4.5l-15 15m0 0h11.25m-11.25 0V8.25" />
      )}
    </svg>
    {trend.value}
  </p>
)}
```

This renders an upward-right arrow (green/success) or downward-left arrow (red/danger) before the percentage text.

7. **Verify graceful fallback behavior:**
- When `trends` is `null` (QB not connected or no prior-year data): `revenueTrend` and `expensesTrend` are both `null`, so no trend badges render. Cards look exactly as they do today.
- When `trends` is `undefined` (still loading): the loading skeleton shows, preventing any flash.
- When individual trend metrics are `null` (e.g. prior-year revenue was 0): that specific card shows no trend badge while others may show theirs.
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - Revenue YTD card displays green up-arrow or red down-arrow with "X.X% vs last year" when trend data exists
    - Total Expenses card displays correct trend indicator (inverted: lower expenses = green)
    - Cash on Hand card has no trend indicator (point-in-time balance)
    - When QB is disconnected, cards render normally without trend badges
    - When prior-year data is null, cards render normally without trend badges
    - Skeleton shimmer displays while trend data loads — no flash of wrong state
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (confirms no runtime import issues)
3. Visual verification: With QB connected, Revenue YTD and Total Expenses cards show directional arrows with percentage change text
4. Visual verification: Cash on Hand card has NO trend indicator
5. Visual verification: QB disconnected state shows "Connect QuickBooks" prompt (no errors from trend query)
6. Visual verification: Dashboard load shows skeleton shimmer, then cards appear WITH trend badges (no intermediate flash)
</verification>

<success_criteria>
- KPI cards show year-over-year trend arrows and percentage changes (DASH-01)
- Trend data is computed from QB historical P&L for current month vs same month prior year (DASH-02)
- Graceful fallback: no errors when QB is disconnected or prior-year data is missing
- Three-state loading: skeleton while loading, no flash of wrong state
- No code duplication: P&L parsing logic shared between existing query and trend query
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-kpi-trends/05-01-SUMMARY.md`
</output>
