---
phase: 07-alert-configuration-persistence
plan: "02"
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(dashboard)/admin/page.tsx
  - src/components/admin/AlertsConfig.tsx
  - src/components/dashboard/WhatNeedsAttention.tsx
autonomous: true
requirements: [ALRT-01, ALRT-02, ALRT-03]

must_haves:
  truths:
    - "Admin console has an 'Alerts' tab where admin/manager users can edit deadline window days, budget variance percentage, QB staleness hours, Sheets staleness hours, and Calendar staleness hours"
    - "A gear icon on the WhatNeedsAttention panel header links to /admin?tab=alerts"
    - "Dismissed alerts do not reappear on subsequent dashboard loads — dismissal stored per-user in Convex via alertDismissals"
    - "Newly surfaced or changed alerts trigger a toast notification via the existing custom ToastProvider"
    - "Alert config changes take effect on the next alert query without requiring a page reload (Convex reactivity)"
  artifacts:
    - path: "src/components/admin/AlertsConfig.tsx"
      provides: "Admin alerts configuration form with 5 threshold inputs and save button"
      min_lines: 60
    - path: "src/app/(dashboard)/admin/page.tsx"
      provides: "Admin page with 'Alerts' as 9th tab"
      contains: "alerts"
    - path: "src/components/dashboard/WhatNeedsAttention.tsx"
      provides: "Gear icon shortcut, dismiss buttons, enhanced toast for all new/changed alerts"
      contains: "alertDismissals"
  key_links:
    - from: "src/components/admin/AlertsConfig.tsx"
      to: "convex/alertConfig.ts"
      via: "useQuery(api.alertConfig.get) and useMutation(api.alertConfig.update)"
      pattern: "api\\.alertConfig"
    - from: "src/components/dashboard/WhatNeedsAttention.tsx"
      to: "convex/alertDismissals.ts"
      via: "useMutation(api.alertDismissals.dismiss) and useQuery(api.alertDismissals.getMyDismissals)"
      pattern: "api\\.alertDismissals"
    - from: "src/app/(dashboard)/admin/page.tsx"
      to: "src/components/admin/AlertsConfig.tsx"
      via: "import and render in 'alerts' case"
      pattern: "AlertsConfig"
---

<objective>
Add the Alerts admin tab, gear icon shortcut on the attention panel, per-user dismissal UI, and enhanced toast notifications for all new/changed alerts.

Purpose: Completes the user-facing experience — Kareem can configure alert thresholds, dismiss alerts he has addressed, and get toast notifications for any new or changed alerts.
Output: New AlertsConfig.tsx component, updated admin page with Alerts tab, and enhanced WhatNeedsAttention.tsx with gear icon, dismiss buttons, and comprehensive toast notifications.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/app/(dashboard)/admin/page.tsx
@src/components/dashboard/WhatNeedsAttention.tsx
@src/components/ui/Toast.tsx
@convex/alertConfig.ts (created by 07-01)
@convex/alertDismissals.ts (created by 07-01)

<interfaces>
<!-- Key types and contracts from Plan 07-01 that this plan consumes. -->

From convex/alertConfig.ts (created by 07-01):
```typescript
export const ALERT_DEFAULTS = {
  deadlineWindowDays: 30,
  budgetVariancePct: 90,
  qbStalenessHours: 1,
  sheetsStalenessHours: 2,
  calendarStalenessHours: 2,
} as const;

export const get = query({ handler: ... });
// Returns: { deadlineWindowDays, budgetVariancePct, qbStalenessHours, sheetsStalenessHours, calendarStalenessHours }

export const update = mutation({
  args: { deadlineWindowDays: v.number(), budgetVariancePct: v.number(), qbStalenessHours: v.number(), sheetsStalenessHours: v.number(), calendarStalenessHours: v.number() },
  handler: ... // requireRole("admin", "manager") guarded
});
```

From convex/alertDismissals.ts (created by 07-01):
```typescript
export const dismiss = mutation({ args: { alertKey: v.string() }, handler: ... });
export const undismiss = mutation({ args: { alertKey: v.string() }, handler: ... });
export const getMyDismissals = query({ handler: ... }); // Returns string[] of dismissed alertKeys
```

From convex/alerts.ts:
```typescript
export interface Alert {
  id: string;
  type: "deadline" | "budget" | "sync" | "integration";
  severity: "critical" | "warning" | "info";
  title: string;
  description: string;
  action?: { label: string; href: string };
  urgencyScore: number;
}
```

From src/components/ui/Toast.tsx:
```typescript
export function useToast(): { toasts: ToastData[], toast: (input: ToastInput) => void, dismiss: (id: string) => void };
// ToastInput: { title: string, description?: string, variant: "success" | "error" | "warning" | "info" }
```

Admin page tab system:
```typescript
type AdminTab = "users" | "quickbooks" | "constant-contact" | "google-sheets" | "google-calendar" | "knowledge-base" | "audit-log" | "ai-config";
const TABS: { id: AdminTab; label: string; icon: React.ReactNode }[] = [...];
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AlertsConfig component and add Alerts tab to admin page</name>
  <files>src/components/admin/AlertsConfig.tsx, src/app/(dashboard)/admin/page.tsx</files>
  <action>
**1. Create `src/components/admin/AlertsConfig.tsx`:**

A form component that loads current alert config and allows editing. Follow the same card + form pattern used by SettingsPanel in admin/page.tsx.

```typescript
"use client";

import { useState, useEffect } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { cn } from "@/lib/utils";
```

**Component behavior:**
- `useQuery(api.alertConfig.get)` to load current thresholds
- `useMutation(api.alertConfig.update)` to save
- useState for each of the 5 threshold fields, initialized from query data via useEffect (same pattern as SettingsPanel's promptLoaded guard)
- Input fields: all `type="number"` with sensible min/step attributes
  - Deadline Window: min=1, max=365, step=1, label "Deadline Window (days)", helper text "Alerts appear for grant report deadlines within this many days"
  - Budget Variance: min=50, max=100, step=1, label "Budget Alert Threshold (%)", helper text "Alerts when grant spending exceeds this percentage of total budget"
  - QB Staleness: min=0.5, max=48, step=0.5, label "QuickBooks Staleness (hours)", helper text "Alert when QuickBooks data hasn't synced within this many hours"
  - Sheets Staleness: min=0.5, max=48, step=0.5, label "Google Sheets Staleness (hours)", helper text "Alert when Sheets data hasn't synced within this many hours"
  - Calendar Staleness: min=0.5, max=48, step=0.5, label "Google Calendar Staleness (hours)", helper text "Alert when Calendar data hasn't synced within this many hours"
- Save button: calls `update` mutation with all 5 values. Show success/error message below button (same pattern as SettingsPanel).
- "Reset to Defaults" text button that resets all fields to defaults (30, 90, 1, 2, 2) without saving — user must click Save.
- Wrap in a `bg-surface rounded-2xl border border-border p-6 shadow-[var(--warm-shadow-sm)]` card.
- Add a brief description paragraph above the form: "Configure alert thresholds to control which alerts appear in the What Needs Attention panel. Changes take effect immediately for all users."

**2. Modify `src/app/(dashboard)/admin/page.tsx`:**

a. Add `"alerts"` to the `AdminTab` union type:
```typescript
type AdminTab = "users" | "quickbooks" | "constant-contact" | "google-sheets" | "google-calendar" | "knowledge-base" | "audit-log" | "ai-config" | "alerts";
```

b. Add an Alerts entry to the `TABS` array — insert it BEFORE "audit-log" so it appears in a logical position (after integrations, before system internals). Use a bell/cog hybrid icon — a simple gear/cog SVG icon:
```typescript
{
  id: "alerts",
  label: "Alerts",
  icon: (
    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 01-.12-1.45l.527-.737c.25-.35.273-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.107-1.204l-.527-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894z" />
      <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
  ),
},
```

c. Add import for AlertsConfig at top of file:
```typescript
import AlertsConfig from "@/components/admin/AlertsConfig";
```

d. Add case to `renderTabContent()`:
```typescript
case "alerts":
  return <AlertsConfig />;
```
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npm run build 2>&1 | tail -10</automated>
  </verify>
  <done>
    - AlertsConfig.tsx component renders 5 threshold input fields with labels, helper text, Save, and Reset to Defaults buttons
    - Admin page has "Alerts" tab accessible at /admin?tab=alerts
    - Tab uses a gear/cog icon consistent with the design system
    - Save calls api.alertConfig.update mutation
    - Production build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add gear icon shortcut, dismiss buttons, and enhanced toast notifications to WhatNeedsAttention</name>
  <files>src/components/dashboard/WhatNeedsAttention.tsx</files>
  <action>
Modify `WhatNeedsAttention.tsx` to add three features: gear icon shortcut, per-alert dismiss buttons, and enhanced toast notifications for all new/changed alerts (not just critical).

**1. Add imports:**
```typescript
import { useQuery, useMutation } from "convex/react";
import Link from "next/link";
```
(useMutation is new; Link is new)

**2. Add gear icon shortcut to panel header:**

In the header div (the one with BellIcon and "What Needs Attention" title), add a gear icon link BEFORE the count badge. Use Next.js `<Link>` component:
```typescript
<Link
  href="/admin?tab=alerts"
  className="p-1.5 rounded-lg text-muted hover:text-foreground hover:bg-surface-hover transition-colors"
  title="Configure alert thresholds"
>
  <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 010-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.28z" />
    <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
  </svg>
</Link>
```

Place this between the title `<h2>` and the count badge `<span>`, within the header's flex layout. The `flex-1` on the h2 will push the gear icon and badge to the right.

Actually, restructure the header so the gear icon sits to the right of the title, before the badge:
```tsx
<h2 className="flex-1 text-base font-semibold text-foreground font-[family-name:var(--font-fraunces)]">
  What Needs Attention
</h2>
<Link href="/admin?tab=alerts" className="..." title="Configure alert thresholds">
  {/* gear SVG */}
</Link>
{!isLoading && (
  <span className="rounded-full bg-primary text-white text-xs font-medium px-2.5 py-0.5 tabular-nums">
    {visibleAlerts.length}
  </span>
)}
```

**3. Add dismiss functionality:**

Add queries and mutations at component top:
```typescript
const dismissedKeys = useQuery(api.alertDismissals.getMyDismissals);
const dismissAlert = useMutation(api.alertDismissals.dismiss);
```

Compute visible alerts (filter out dismissed):
```typescript
const visibleAlerts = alerts && dismissedKeys !== undefined
  ? alerts.filter((a) => !dismissedKeys.includes(a.id))
  : undefined;
```

Use `visibleAlerts` instead of `alerts` in the rendering logic (isLoading check becomes `visibleAlerts === undefined`).

Add a dismiss button (X icon) to each alert item, at the far right after the action button:
```tsx
<button
  onClick={() => dismissAlert({ alertKey: alert.id })}
  className="shrink-0 p-1 rounded-lg text-muted hover:text-foreground hover:bg-surface-hover transition-colors"
  title="Dismiss alert"
>
  <svg className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
  </svg>
</button>
```

**4. Enhanced toast notifications for ALL new/changed alerts (ALRT-03):**

Replace the current toast logic that only fires for `severity === "critical"` with a system that fires toasts for any NEW alert that wasn't in the previous render's alert list.

Use `useRef` to track the PREVIOUS set of alert IDs:
```typescript
const prevAlertIds = useRef<Set<string>>(new Set());
const initialLoadDone = useRef(false);
```

Replace the existing useEffect:
```typescript
useEffect(() => {
  if (!visibleAlerts) return;

  // On first load, populate prevAlertIds but don't toast (avoid toasting everything on page load)
  if (!initialLoadDone.current) {
    initialLoadDone.current = true;
    prevAlertIds.current = new Set(visibleAlerts.map((a) => a.id));
    // Still toast critical alerts on first load (existing behavior)
    for (const alert of visibleAlerts) {
      if (alert.severity === "critical" && !toastedIds.current.has(alert.id)) {
        toastedIds.current.add(alert.id);
        toast({
          title: alert.title,
          description: alert.description,
          variant: "warning",
        });
      }
    }
    return;
  }

  // On subsequent updates, toast any NEW alerts (not in previous set)
  const currentIds = new Set(visibleAlerts.map((a) => a.id));
  for (const alert of visibleAlerts) {
    if (!prevAlertIds.current.has(alert.id) && !toastedIds.current.has(alert.id)) {
      toastedIds.current.add(alert.id);
      const variant = alert.severity === "critical" ? "warning" : "info";
      toast({
        title: alert.title,
        description: alert.description,
        variant,
      });
    }
  }
  prevAlertIds.current = currentIds;
}, [visibleAlerts, toast]);
```

This ensures:
- First page load: only critical alerts get toasted (existing behavior preserved)
- Subsequent Convex query updates: any NEW alert IDs trigger a toast (info variant for non-critical, warning for critical)
- Dismissed alerts that reappear (undismissed) also trigger a toast
- `toastedIds` ref prevents duplicate toasts within the same session

**5. Update the alert count badge** to use `visibleAlerts.length` instead of `alerts.length`.

**6. Keep `isLoading` derived from both queries:**
```typescript
const isLoading = alerts === undefined || dismissedKeys === undefined;
```
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npm run build 2>&1 | tail -10</automated>
  </verify>
  <done>
    - Gear icon (cog SVG) in WhatNeedsAttention header links to /admin?tab=alerts
    - Each alert item has a dismiss (X) button that calls api.alertDismissals.dismiss
    - Dismissed alerts filtered from view using getMyDismissals query data
    - Toast notifications fire for critical alerts on first load, and for ALL new alerts on subsequent Convex updates
    - Alert count badge reflects visible (non-dismissed) alerts
    - Production build passes
  </done>
</task>

</tasks>

<verification>
1. Admin page has 9 tabs — "Alerts" tab is present and accessible at /admin?tab=alerts
2. AlertsConfig form displays 5 number inputs with labels and helper text, pre-populated from Convex data
3. Save button on AlertsConfig calls api.alertConfig.update and shows success message
4. Reset to Defaults button resets form fields to (30, 90, 1, 2, 2) without saving
5. WhatNeedsAttention panel header has a gear icon linking to /admin?tab=alerts
6. Each alert item has a dismiss (X) button
7. Dismissed alerts do not appear in the panel on subsequent loads (persisted in Convex)
8. On first dashboard load, critical alerts trigger warning toasts
9. When Convex data updates surface a new alert, a toast notification fires
10. `npm run build` passes
</verification>

<success_criteria>
- Admin Alerts tab at /admin?tab=alerts with 5 editable threshold fields and Save/Reset buttons
- Gear icon shortcut on WhatNeedsAttention panel links to /admin?tab=alerts
- Alert dismiss button calls api.alertDismissals.dismiss — dismissed alerts hidden across sessions
- Toast system fires for critical on first load, for all new alerts on subsequent Convex updates
- Convex reactivity ensures config changes take effect without page reload
- Production build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/07-alert-configuration-persistence/07-02-SUMMARY.md`
</output>
