---
phase: 03-google-calendar-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - convex/crons.ts
  - src/app/(dashboard)/admin/page.tsx
  - src/components/admin/GoogleCalendarConfig.tsx
  - src/hooks/useGoogleCalendar.ts
  - src/lib/constants.ts
autonomous: true
requirements: [CAL-02, CAL-03]

must_haves:
  truths:
    - "crons.ts registers 'google-calendar-sync' interval at 30 minutes pointing to internal.googleCalendarSync.runSync"
    - "Admin page has 'Google Calendar' tab between 'Google Sheets' and 'Knowledge Base'"
    - "GoogleCalendarConfig.tsx displays status dot (green if lastSyncAt exists, amber if not), last sync badge, calendar list with add/remove, Save & Test button, and Sync Now button"
    - "Admin tab URL is /admin?tab=google-calendar"
    - "CALENDAR_DOT_COLORS constant exported from constants.ts for widget color assignment"
  artifacts:
    - src/components/admin/GoogleCalendarConfig.tsx
    - src/hooks/useGoogleCalendar.ts
  key_links:
    - "GoogleCalendarConfig.tsx calls api.googleCalendar.saveConfig mutation and api.googleCalendarActions.triggerSync action"
    - "crons.ts imports internal.googleCalendarSync.runSync for the cron job"
    - "Admin page imports GoogleCalendarConfig and renders it for 'google-calendar' tab"
---

<objective>
Wire the cron schedule for automatic calendar sync and build the Admin console "Google Calendar" tab for configuring which calendar IDs to sync.

Purpose: Enable admins to configure calendar IDs and trigger syncs, and enable automatic background sync every 30 minutes.
Output: Cron registration, admin tab component, hooks, color palette constant.
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-google-calendar-integration/03-CONTEXT.md
@.planning/phases/03-google-calendar-integration/03-01-SUMMARY.md

@convex/crons.ts
@convex/googleCalendar.ts
@convex/googleCalendarActions.ts
@src/app/(dashboard)/admin/page.tsx
@src/components/admin/GoogleSheetsConfig.tsx
@src/hooks/useGrantTracker.ts
@src/lib/constants.ts

<interfaces>
<!-- Contracts from Plan 01 that this plan consumes -->

From convex/googleCalendar.ts (created in Plan 01):
```typescript
export const getConfig: query → returns null | { _id, calendars: {calendarId, displayName}[], lastSyncAt }
export const saveConfig: mutation({ calendars: v.array(v.object({ calendarId: v.string(), displayName: v.string() })) })
```

From convex/googleCalendarActions.ts (created in Plan 01):
```typescript
export const triggerSync: action → runs full calendar sync
```

From convex/googleCalendarSync.ts (created in Plan 01):
```typescript
export const runSync: internalAction → cron entrypoint
```

From src/hooks/useGrantTracker.ts (pattern to mirror for hooks):
```typescript
export function useSheetsConfig() { return useQuery(api.googleSheets.getConfig); }
export function useSheetsSync() { const triggerSync = useAction(api.googleSheetsActions.triggerSync); return { triggerSync }; }
```

From src/app/(dashboard)/admin/page.tsx (tab registration pattern):
```typescript
type AdminTab = "users" | "quickbooks" | "constant-contact" | "google-sheets" | "knowledge-base" | "audit-log" | "ai-config";
const TABS: { id: AdminTab; label: string; icon: React.ReactNode }[] = [...]
// renderTabContent() switch statement
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register cron job, create hooks, and add color palette constant</name>
  <files>convex/crons.ts, src/hooks/useGoogleCalendar.ts, src/lib/constants.ts</files>
  <action>
**In `convex/crons.ts`**, add a third cron entry after the existing "sheets-sync" block:

```typescript
// Sync Google Calendar events every 30 minutes
crons.interval(
  "google-calendar-sync",
  { minutes: 30 },
  internal.googleCalendarSync.runSync
);
```

**Create `src/hooks/useGoogleCalendar.ts`** — mirrors `useGrantTracker.ts` pattern:

```typescript
"use client";

import { useQuery, useAction } from "convex/react";
import { api } from "../../convex/_generated/api";

export function useCalendarConfig() {
  return useQuery(api.googleCalendar.getConfig);
}

export function useCalendarEvents() {
  return useQuery(api.googleCalendar.getEvents);
}

export function useCalendarSync() {
  const triggerSync = useAction(api.googleCalendarActions.triggerSync);
  return { triggerSync };
}
```

**In `src/lib/constants.ts`**, add after the `BRAND_COLORS` object:

```typescript
// Calendar dot colors — deterministic index-based assignment from DEC theme palette
export const CALENDAR_DOT_COLORS = [
  "#1B5E6B", // primary teal
  "#6BBF59", // accent green
  "#2B9E9E", // mid teal
  "#8CC63F", // lime
  "#5BBFB5", // light teal
  "#1A7A7A", // dark teal
] as const;
```

Also add `"calendar"` entry to `DEFAULT_DASHBOARD_SECTIONS` — position it after `"client-activity"` (last in the list, since calendar is supplementary to core financial/program data):

```typescript
{
  id: "calendar",
  title: "Calendar",
  description: "Upcoming events and schedule",
},
```
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - `crons.ts` has three cron entries: quickbooks-sync (15min), sheets-sync (30min), google-calendar-sync (30min)
    - `useGoogleCalendar.ts` exports `useCalendarConfig`, `useCalendarEvents`, `useCalendarSync`
    - `constants.ts` exports `CALENDAR_DOT_COLORS` array and `DEFAULT_DASHBOARD_SECTIONS` includes `"calendar"` entry
  </done>
</task>

<task type="auto">
  <name>Task 2: Build GoogleCalendarConfig admin tab and register in admin page</name>
  <files>src/components/admin/GoogleCalendarConfig.tsx, src/app/(dashboard)/admin/page.tsx</files>
  <action>
**Create `src/components/admin/GoogleCalendarConfig.tsx`** — mirrors `GoogleSheetsConfig.tsx` pattern.

Component structure:
1. **Status header**: Status dot (green if `lastSyncAt` exists, amber otherwise) + "Configured"/"Not Configured" badge + last sync timestamp badge (using `timeAgo` from `@/lib/utils`)
2. **Info text**: "Configure Google Calendar IDs to sync. Each calendar must be shared with the service account email before events will appear."
3. **Calendar list**: Render each existing calendar entry as a row showing `calendarId` and `displayName` with a red "Remove" button
4. **Add Calendar row**: Two text inputs (Calendar ID placeholder "e.g. abc123@group.calendar.google.com", Display Name placeholder "e.g. DEC Board") + "Add" button. Add button appends to local state array
5. **Action buttons**:
   - "Save & Test" — calls `saveConfig` mutation with current calendars array, then calls `triggerSync` action. Shows success/error message. Disabled when no calendars.
   - "Sync Now" — calls `triggerSync` action directly. Disabled when no calendars configured.

State management:
- Local `calendars` state array `{calendarId: string, displayName: string}[]` initialized from `useCalendarConfig()` on mount (useEffect)
- Local `newCalendarId` and `newDisplayName` for the add row
- `saving` and `syncing` boolean states for button disabled/loading
- `message` state for success/error feedback

Key UI patterns (from existing admin components):
- Card wrapper: `className="bg-surface rounded-2xl border border-border p-6 shadow-[var(--warm-shadow-sm)]"`
- Status badge: `className="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium"` with green/amber variants
- Inputs: Use `Input` component from `@/components/ui/Input` or raw input with `className="w-full px-3 py-2 text-sm rounded-lg border border-border bg-background text-foreground placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-primary"`
- Buttons: Use `Button` component from `@/components/ui/Button` or raw button with primary styling
- Calendar row items: Each row in a `div` with `flex items-center gap-3 py-2 border-b border-border last:border-0`

Import from hooks: `useCalendarConfig`, `useCalendarSync` from `@/hooks/useGoogleCalendar`
Import mutation: `useMutation(api.googleCalendar.saveConfig)`
Import utils: `timeAgo` from `@/lib/utils`

**In `src/app/(dashboard)/admin/page.tsx`**, make three changes:

1. Add `"google-calendar"` to the `AdminTab` union type (after `"google-sheets"`):
```typescript
type AdminTab =
  | "users"
  | "quickbooks"
  | "constant-contact"
  | "google-sheets"
  | "google-calendar"
  | "knowledge-base"
  | "audit-log"
  | "ai-config";
```

2. Add a new tab entry in the `TABS` array — insert it after the "Google Sheets" entry (index 3) and before "Knowledge Base" (index 4). Use a calendar SVG icon:
```typescript
{
  id: "google-calendar",
  label: "Google Calendar",
  icon: (
    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
    </svg>
  ),
},
```

3. Add import at top: `import GoogleCalendarConfig from "@/components/admin/GoogleCalendarConfig";`

4. Add case in `renderTabContent()` switch:
```typescript
case "google-calendar":
  return <GoogleCalendarConfig />;
```
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - `GoogleCalendarConfig.tsx` renders with status dot, last sync badge, calendar list CRUD, Save & Test, and Sync Now buttons
    - Admin page shows "Google Calendar" tab between "Google Sheets" and "Knowledge Base"
    - Navigating to `/admin?tab=google-calendar` renders the GoogleCalendarConfig component
    - TypeScript compiles with no errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — all modified files compile
2. `convex/crons.ts` has `"google-calendar-sync"` entry at 30-minute interval
3. `src/hooks/useGoogleCalendar.ts` exports three hooks
4. `src/lib/constants.ts` has `CALENDAR_DOT_COLORS` and "calendar" in `DEFAULT_DASHBOARD_SECTIONS`
5. Admin page has 8 tabs (was 7) with "Google Calendar" visible
6. `GoogleCalendarConfig.tsx` renders calendar list with add/remove, Save & Test, Sync Now
</verification>

<success_criteria>
- Calendar sync cron runs every 30 minutes automatically
- Admin can navigate to /admin?tab=google-calendar
- Admin can add calendar IDs with display names, save configuration, and trigger manual sync
- Status dot shows green when configured with last sync time, amber when not configured
</success_criteria>

<output>
After completion, create `.planning/phases/03-google-calendar-integration/03-02-SUMMARY.md`
</output>
