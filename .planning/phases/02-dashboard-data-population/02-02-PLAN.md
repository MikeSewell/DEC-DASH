---
phase: 02-dashboard-data-population
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/dashboard/skeletons/StatCardSkeleton.tsx
  - src/components/dashboard/skeletons/ChartSkeleton.tsx
  - src/components/dashboard/skeletons/TableSkeleton.tsx
  - src/components/dashboard/ProfitLoss.tsx
  - src/components/dashboard/GrantBudget.tsx
  - src/components/dashboard/GrantTracking.tsx
  - src/components/dashboard/ProgramsCoparent.tsx
  - src/components/dashboard/ProgramsLegal.tsx
  - src/components/dashboard/DonationPerformance.tsx
autonomous: true
requirements: [DASH-02, DASH-03, DASH-04, DASH-05, CMD-04]

must_haves:
  truths:
    - "Every dashboard section shows a skeleton shimmer while its data loads (not a spinner)"
    - "When QuickBooks is not connected, QB-dependent sections show an inline Connect QuickBooks prompt"
    - "When Google Sheets is not connected, Sheets-dependent sections show an inline Connect Google Sheets prompt"
    - "Each section loads independently — one failing section does not break other sections"
    - "P&L doughnut, grant budget bars, and demographics charts render with real data when connected"
    - "GrantTracking shows active grants with status from grantsCache"
    - "DonationPerformance shows clean empty state (not broken) since no donation data exists"
  artifacts:
    - path: "src/components/dashboard/skeletons/StatCardSkeleton.tsx"
      provides: "Reusable skeleton for stat card grids"
      exports: ["StatCardSkeleton"]
    - path: "src/components/dashboard/skeletons/ChartSkeleton.tsx"
      provides: "Reusable skeleton for chart containers"
      exports: ["ChartSkeleton"]
    - path: "src/components/dashboard/skeletons/TableSkeleton.tsx"
      provides: "Reusable skeleton for table/list containers"
      exports: ["TableSkeleton"]
  key_links:
    - from: "ProfitLoss.tsx"
      to: "skeletons/ChartSkeleton.tsx"
      via: "import in loading branch"
      pattern: "ChartSkeleton"
    - from: "GrantTracking.tsx"
      to: "skeletons/TableSkeleton.tsx"
      via: "import in loading branch"
      pattern: "TableSkeleton"
    - from: "Each section component"
      to: "useQuery === undefined check"
      via: "three-state pattern"
      pattern: "=== undefined"
---

<objective>
Create reusable skeleton shimmer components and standardize three-state loading (skeleton/disconnected/data) across all 7 existing dashboard section components.

Purpose: Per user decision, loading states must use skeleton shimmer (animated gray blocks matching content shape), not spinners. Disconnected states must show inline "Connect [Integration]" prompts. This is the visual foundation for CMD-04 (independent section loading) and DASH-03 (three-state loading). Charts (DASH-02), grant tracking (DASH-04), and demographics (DASH-05) must render real data when connected.

Output: 3 skeleton components + 7 updated dashboard section components with standardized loading pattern
</objective>

<execution_context>
@/Users/mastermac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mastermac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-dashboard-data-population/02-RESEARCH.md

<interfaces>
<!-- Existing component patterns the executor needs to understand -->

From src/components/dashboard/ProfitLoss.tsx (correct three-state pattern):
```typescript
const plResult = useProfitAndLoss();
if (plResult === undefined) {
  return <Spinner ... />;    // CHANGE TO: <ChartSkeleton />
}
if (plResult === null) {
  return <ConnectQBPrompt />;  // Already correct — keep this pattern
}
// render with plResult.data
```

From src/hooks/useQuickBooks.ts:
```typescript
export function useQuickBooksConfig() { return useQuery(api.quickbooks.getConfig); }
export function useProfitAndLoss() { return useQuery(api.quickbooks.getProfitAndLoss); }
export function useAccounts() { return useQuery(api.quickbooks.getAccounts); }
```

From src/hooks/useGrantTracker.ts (relevant hooks):
```typescript
export function useGrants() { return useQuery(api.googleSheets.getGrants); }
export function useActiveGrants() { return useQuery(api.googleSheets.getActiveGrants); }
export function useGrantDeadlines() { return useQuery(api.googleSheets.getGrantDeadlines); }
```

From convex/quickbooks.ts getConfig:
```typescript
// Returns null if QB not configured, or { _id, realmId, companyName, connectedAt, isExpired }
export const getConfig = query({ ... });
```

From convex/googleSheets.ts getConfig:
```typescript
// Returns null if Sheets not configured, or { _id, spreadsheetId, sheetName, serviceAccountEmail, lastSyncAt }
export const getConfig = query({ ... });
```

From src/components/dashboard/ExecutiveSnapshot.tsx StatCard:
```typescript
interface StatCardProps {
  icon: React.ReactNode;
  value: string | number;
  label: string;
  trend?: { value: string; positive: boolean } | null;
  loading?: boolean;
  accentColor?: string;
}
```

Design system tokens:
- border-border: warm border color
- bg-surface: card surface color
- animate-pulse: Tailwind shimmer animation
- rounded-2xl: card border radius
- shadow-[var(--warm-shadow-sm)]: card shadow
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable skeleton shimmer components</name>
  <files>
    src/components/dashboard/skeletons/StatCardSkeleton.tsx
    src/components/dashboard/skeletons/ChartSkeleton.tsx
    src/components/dashboard/skeletons/TableSkeleton.tsx
  </files>
  <action>
Create directory `src/components/dashboard/skeletons/` and three skeleton components. Each uses Tailwind `animate-pulse` with `bg-border/50` and `bg-border/30` blocks matching the shape of real content.

**StatCardSkeleton.tsx** — matches the 4-card grid in ExecutiveSnapshot:
```typescript
"use client";

export function StatCardSkeleton() {
  return (
    <div className="flex items-start gap-4 rounded-2xl border border-border bg-surface p-5 shadow-[var(--warm-shadow-sm)] animate-pulse">
      <div className="h-11 w-11 rounded-xl bg-border/50 shrink-0" />
      <div className="flex-1 space-y-2 pt-1">
        <div className="h-7 w-24 rounded-md bg-border/50" />
        <div className="h-3 w-16 rounded-md bg-border/30" />
      </div>
    </div>
  );
}

export function StatCardGridSkeleton({ count = 4 }: { count?: number }) {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      {Array.from({ length: count }).map((_, i) => (
        <StatCardSkeleton key={i} />
      ))}
    </div>
  );
}
```

**ChartSkeleton.tsx** — matches doughnut/bar chart containers:
```typescript
"use client";

export function ChartSkeleton({ height = 280 }: { height?: number }) {
  return (
    <div className="animate-pulse space-y-4">
      {/* Stat cards row */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
        {[1, 2, 3].map((i) => (
          <div key={i} className="rounded-2xl border border-border bg-surface p-5 shadow-[var(--warm-shadow-sm)]">
            <div className="h-3 w-20 rounded-md bg-border/30 mb-2" />
            <div className="h-7 w-24 rounded-md bg-border/50" />
          </div>
        ))}
      </div>
      {/* Chart area */}
      <div className="h-4 w-32 rounded-md bg-border/30" />
      <div className="rounded-xl bg-border/20" style={{ height }} />
    </div>
  );
}

export function BarChartSkeleton({ bars = 5, height = 200 }: { bars?: number; height?: number }) {
  return (
    <div className="animate-pulse">
      <div className="flex items-end gap-3 justify-around" style={{ height }}>
        {Array.from({ length: bars }).map((_, i) => (
          <div
            key={i}
            className="flex-1 rounded-t-lg bg-border/30"
            style={{ height: `${30 + Math.random() * 60}%` }}
          />
        ))}
      </div>
    </div>
  );
}
```

**TableSkeleton.tsx** — matches grant tracking table and list layouts:
```typescript
"use client";

export function TableSkeleton({ rows = 5 }: { rows?: number }) {
  return (
    <div className="animate-pulse space-y-3">
      {/* Header row */}
      <div className="flex gap-4 pb-2 border-b border-border/50">
        <div className="h-3 w-24 rounded-md bg-border/40" />
        <div className="h-3 w-32 rounded-md bg-border/40" />
        <div className="h-3 w-20 rounded-md bg-border/40" />
        <div className="h-3 w-16 rounded-md bg-border/40" />
      </div>
      {/* Data rows */}
      {Array.from({ length: rows }).map((_, i) => (
        <div key={i} className="flex gap-4 py-2">
          <div className="h-4 w-28 rounded-md bg-border/30" />
          <div className="h-4 w-36 rounded-md bg-border/20" />
          <div className="h-4 w-20 rounded-md bg-border/20" />
          <div className="h-4 w-16 rounded-md bg-border/30" />
        </div>
      ))}
    </div>
  );
}

export function ListSkeleton({ items = 4 }: { items?: number }) {
  return (
    <div className="animate-pulse space-y-4">
      {Array.from({ length: items }).map((_, i) => (
        <div key={i} className="flex items-center gap-3">
          <div className="h-8 w-8 rounded-full bg-border/30 shrink-0" />
          <div className="flex-1 space-y-1.5">
            <div className="h-4 w-3/4 rounded-md bg-border/30" />
            <div className="h-3 w-1/2 rounded-md bg-border/20" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

All three files use `"use client"` directive and export named exports (no default export — these are utility components).
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>
    - 3 skeleton files exist in src/components/dashboard/skeletons/
    - Each exports named skeleton components
    - All use animate-pulse + bg-border/[30|50] pattern
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Standardize three-state loading across all dashboard sections</name>
  <files>
    src/components/dashboard/ProfitLoss.tsx
    src/components/dashboard/GrantBudget.tsx
    src/components/dashboard/GrantTracking.tsx
    src/components/dashboard/ProgramsCoparent.tsx
    src/components/dashboard/ProgramsLegal.tsx
    src/components/dashboard/DonationPerformance.tsx
  </files>
  <action>
Update each of the 6 dashboard section components (NOT ExecutiveSnapshot — that's in Plan 02-04) to use the standardized three-state pattern: `=== undefined` -> skeleton, `=== null` -> disconnected prompt, data -> render.

**Pattern for QB-dependent components (ProfitLoss, GrantBudget, DonationPerformance):**
Replace `<Spinner>` loading states with the appropriate skeleton component. The disconnected state (null check) is already mostly correct in these components — verify it shows a friendly "Connect QuickBooks" message with a link to `/admin`.

For each component:
1. Add skeleton import: `import { ChartSkeleton } from "@/components/dashboard/skeletons/ChartSkeleton"` (or BarChartSkeleton as appropriate)
2. Replace the `undefined` branch (currently shows Spinner) with the skeleton component
3. Ensure the `null` branch shows a "Connect QuickBooks" prompt with icon + text + link

**ProfitLoss.tsx:**
- Replace `<Spinner size="lg" />` in the undefined branch (line 34-40) with `<ChartSkeleton />`
- The null branch (lines 42-52) already shows a good message — keep it, but add a link to `/admin`: `<a href="/admin" className="text-primary hover:underline text-xs mt-2 inline-block">Connect QuickBooks →</a>`
- Add `fetchedAt` timestamp display if not already present (it is — line 169 — keep it)

**GrantBudget.tsx:**
- Read the component first. Replace spinner loading with `<BarChartSkeleton />` from ChartSkeleton
- Ensure null state shows "Connect QuickBooks" prompt
- Already has some null handling — standardize to match ProfitLoss pattern

**DonationPerformance.tsx:**
- Read the component first. This will stay in null/empty state (no donation data source exists — per Pitfall 5 in research)
- Replace spinner with skeleton
- Ensure the empty/null state shows a friendly message: "No donation data available yet." (NOT a broken state)
- Do NOT try to wire QB data — there is no donations reportType

**Pattern for Sheets-dependent components (GrantTracking, ProgramsCoparent, ProgramsLegal):**
These need BOTH a Sheets config check AND a data check. Add `useQuery(api.googleSheets.getConfig)` to distinguish "not connected" from "connected but no data":

```typescript
import { useQuery } from "convex/react";
import { api } from "../../../../convex/_generated/api";

// In the component:
const sheetsConfig = useQuery(api.googleSheets.getConfig);
const data = useExistingDataHook(); // existing hook

if (data === undefined || sheetsConfig === undefined) {
  return <TableSkeleton />; // or appropriate skeleton
}
if (sheetsConfig === null) {
  // Sheets not connected
  return (
    <div className="flex flex-col items-center justify-center py-12 text-muted">
      <Icon ... />
      <p className="text-sm">Connect Google Sheets to view this data.</p>
      <a href="/admin" className="text-primary hover:underline text-xs mt-2">Configure Google Sheets →</a>
    </div>
  );
}
if (!data || (Array.isArray(data) && data.length === 0)) {
  // Connected but no data yet
  return (
    <div className="flex flex-col items-center justify-center py-12 text-muted">
      <Icon ... />
      <p className="text-sm">No data synced yet.</p>
      <p className="text-xs mt-1">Data will appear after the next sync cycle.</p>
    </div>
  );
}
// render with data
```

**GrantTracking.tsx:** Replace spinner with `<TableSkeleton />`. Add sheetsConfig check. Renders from `grantsCache` via `useActiveGrants()` / `useGrantDeadlines()` — correct source, do not change.

**ProgramsCoparent.tsx:** Replace spinner with `<ChartSkeleton height={200} />`. Add sheetsConfig check. Renders from `programDataCache` — correct source.

**ProgramsLegal.tsx:** Same pattern as ProgramsCoparent.

For the disconnected-state icons, use a simple SVG similar to what ProfitLoss already uses (chart/document icon). Keep consistent styling: centered, `text-muted`, `opacity-40` icon, friendly text.

Do NOT change the data rendering logic in any component — only the loading and empty states.
  </action>
  <verify>
    <automated>cd "/Users/mastermac/Desktop/DEC-DASH 2.0" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - All 6 section components use skeleton shimmer for loading (no Spinners in loading branch)
    - QB-dependent components (ProfitLoss, GrantBudget, DonationPerformance) show "Connect QuickBooks" when QB null
    - Sheets-dependent components (GrantTracking, ProgramsCoparent, ProgramsLegal) distinguish "not connected" from "no data"
    - DonationPerformance shows a clean empty state without attempting to wire missing data
    - Data rendering logic unchanged in all components
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — all skeleton imports resolve, all components compile
2. No `<Spinner` imports remain in any dashboard section loading branch (grep for `Spinner` in dashboard components — only used in value display, not full-section loading)
3. Each component has `=== undefined` check (not `!data` or `isLoading`) for loading state
4. Each QB-dependent component has a null check leading to "Connect QuickBooks" prompt
5. Each Sheets-dependent component checks `googleSheets.getConfig` separately from data
</verification>

<success_criteria>
- 3 skeleton files exist and export correctly
- All 6 dashboard sections show skeleton shimmer during loading
- Disconnected integrations show inline prompts (not broken states)
- Each section loads independently (CMD-04 — Convex useQuery isolation confirmed)
- No component data rendering logic was altered
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-data-population/02-02-SUMMARY.md`
</output>
